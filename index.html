<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chapter 7: Fine-tuning to Follow Instructions</title>
    <!-- 添加 Prism.js CSS -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/themes/prism.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/themes/prism-okaidia.min.css"
      rel="stylesheet"
    />
    <style>
      :root {
        --primary-color: #2c3e50;
        --secondary-color: #3498db;
        --accent-color: #e74c3c;
        --text-color: #333;
        --background-color: #f5f6fa;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background-color: var(--background-color);
        color: var(--text-color);
        line-height: 1.6;
      }

      .slide {
        width: 100vw;
        height: 100vh;
        padding: 2rem;
        display: none;
        position: absolute;
        top: 0;
        left: 0;
      }

      .slide.active {
        display: flex;
        flex-direction: column;
        justify-content: center;
      }

      .slide-content {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        padding: 2rem;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        max-height: 95vh;
        overflow-y: auto;
      }

      h1 {
        color: var(--primary-color);
        margin-bottom: 1.5rem;
        font-size: 2.5rem;
      }

      h2 {
        color: var(--secondary-color);
        margin: 1rem 0;
        font-size: 1.8rem;
      }

      h3 {
        color: var(--accent-color);
        margin: 0.8rem 0;
        font-size: 1.4rem;
      }

      ul,
      ol {
        margin-left: 2rem;
        margin-bottom: 1rem;
        font-size: 1.2rem;
      }

      li {
        margin-bottom: 0.5rem;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin: 1rem 0;
      }

      th,
      td {
        border: 1px solid #ddd;
        padding: 0.8rem;
        text-align: left;
      }

      th {
        background-color: var(--secondary-color);
        color: white;
      }

      pre {
        background-color: #282c34;
        padding: 1rem;
        border-radius: 5px;
        overflow-x: auto;
        margin: 1rem 0;
      }

      code {
        font-family: "Consolas", monospace;
        font-size: 0.9rem;
      }

      .navigation {
        position: fixed;
        bottom: 20px;
        right: 20px;
        display: flex;
        gap: 10px;
      }

      .nav-btn {
        padding: 10px 20px;
        background-color: var(--secondary-color);
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s;
      }

      .nav-btn:hover {
        background-color: var(--primary-color);
      }

      .emoji {
        font-size: 1.2em;
        margin-right: 0.5rem;
      }
    </style>
  </head>
  <body>
    <!-- Slide 1: Chapter Overview -->
    <div class="slide active">
      <div class="slide-content">
        <h1>
          <span class="emoji">📘</span>Chapter 7: Fine-tuning to Follow
          Instructions
        </h1>
        <h2>章節目標</h2>
        <ul>
          <li>LLM 的指令微調流程（instruction fine-tuning）</li>
          <li>如何準備指令資料集（supervised instruction fine-tuning）</li>
          <li>將指令資料組成訓練批次(Batching)</li>
          <li>載入並微調預訓練模型以遵從人類指令</li>
          <li>從模型中抽取生成結果進行評估</li>
          <li>評估指令微調後的模型效能</li>
        </ul>
      </div>
    </div>

    <!-- Slide 2: Three-Stage Architecture -->
    <div class="slide">
      <div class="slide-content">
        <h2><span class="emoji">🔁</span>三階段架構</h2>

        <div
          style="
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 1.5rem;
          "
        >
          <img
            src="images/ch7_1.png"
            alt="三階段架構圖"
            style="
              max-width: 100%;
              max-height: 40vh;
              object-fit: contain;
              border-radius: 8px;
              box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            "
          />
        </div>

        <div style="display: flex; justify-content: space-between; gap: 1rem">
          <div
            style="
              flex: 1;
              background-color: #f8f9fa;
              padding: 1rem;
              border-radius: 8px;
              border-left: 4px solid #3498db;
            "
          >
            <h3 style="color: #3498db; margin-top: 0">Stage 1: 建立 LLM</h3>
            <ol>
              <li>數據準備與採樣</li>
              <li>注意力機制</li>
              <li>架構設計</li>
              <li>預訓練</li>
            </ol>
          </div>

          <div
            style="
              flex: 1;
              background-color: #f8f9fa;
              padding: 1rem;
              border-radius: 8px;
              border-left: 4px solid #e74c3c;
            "
          >
            <h3 style="color: #e74c3c; margin-top: 0">Stage 2: 基礎模型</h3>
            <ol>
              <li>訓練迴圈</li>
              <li>模型評估</li>
              <li>載入預訓練權重</li>
            </ol>
          </div>

          <div
            style="
              flex: 1;
              background-color: #f8f9fa;
              padding: 1rem;
              border-radius: 8px;
              border-left: 4px solid #2ecc71;
            "
          >
            <h3 style="color: #2ecc71; margin-top: 0">Stage 3: 微調 LLM</h3>
            <ol>
              <li>微調用於分類（如第6章）</li>
              <li>微調用於理解並執行指令（本章主題）</li>
            </ol>
          </div>
        </div>
      </div>
    </div>

    <!-- Slide 3: Instruction Fine-tuning Concept -->
    <div class="slide">
      <div class="slide-content">
        <h2><span class="emoji">🎯</span>Instruction Fine-tuning 概念</h2>

        <div style="display: flex; flex-direction: column; gap: 1.5rem">
          <div
            style="
              background-color: #f8f9fa;
              padding: 1.5rem;
              border-radius: 8px;
              border-left: 4px solid #3498db;
            "
          >
            <h3 style="color: #3498db; margin-top: 0">預訓練模型的限制</h3>
            <p style="font-size: 1.2rem">
              預訓練模型可完成 text completion，但無法理解具體指令，如：
            </p>
            <div
              style="
                display: flex;
                justify-content: space-between;
                gap: 1rem;
                margin-top: 1rem;
              "
            >
              <div
                style="
                  flex: 1;
                  background-color: white;
                  padding: 1rem;
                  border-radius: 6px;
                  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                "
              >
                <p
                  style="
                    font-weight: bold;
                    margin-bottom: 0.5rem;
                    font-size: 1.2rem;
                  "
                >
                  "請修正文法"
                </p>
                <p style="color: #666; font-size: 0.9rem">
                  模型無法理解這是一個指令
                </p>
              </div>
              <div
                style="
                  flex: 1;
                  background-color: white;
                  padding: 1rem;
                  border-radius: 6px;
                  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                "
              >
                <p
                  style="
                    font-weight: bold;
                    margin-bottom: 0.5rem;
                    font-size: 1.2rem;
                  "
                >
                  "將這句轉換為被動語態"
                </p>
                <p style="color: #666; font-size: 0.9rem">
                  模型無法理解這是一個指令
                </p>
              </div>
            </div>
          </div>

          <div
            style="
              background-color: #f8f9fa;
              padding: 1.5rem;
              border-radius: 8px;
              border-left: 4px solid #e74c3c;
            "
          >
            <h3 style="color: #e74c3c; margin-top: 0">解決方案</h3>
            <p style="font-size: 1.2rem">
              因此需要進行
              <strong style="color: #e74c3c"
                >supervised instruction fine-tuning</strong
              >
            </p>
            <div
              style="
                background-color: white;
                padding: 1rem;
                border-radius: 6px;
                margin-top: 1rem;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
              "
            >
              <p style="margin-bottom: 0.5rem; font-size: 1.2rem">
                本章聚焦讓 LLM 理解並產生符合人類需求的回應
              </p>
              <div
                style="display: flex; align-items: center; margin-top: 0.5rem"
              >
                <span style="font-size: 1.5rem; margin-right: 0.5rem">🔄</span>
                <p style="margin: 0; font-size: 1.2rem">
                  從「預測下一個詞」到「理解並執行指令」
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Slide 4: Examples -->
    <div class="slide">
      <div class="slide-content">
        <h2><span class="emoji">🧠</span>指令與預期回應範例</h2>

        <div
          style="
            background-color: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            border-left: 4px solid #3498db;
            margin-bottom: 1.5rem;
          "
        >
          <p style="font-size: 1.2rem; margin-bottom: 1rem">
            以下是三個指令微調的範例，展示了模型如何從「預測下一個詞」轉變為「理解並執行指令」：
          </p>
        </div>

        <div style="overflow-x: auto">
          <table
            style="
              width: 100%;
              border-collapse: separate;
              border-spacing: 0;
              border-radius: 8px;
              overflow: hidden;
              box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            "
          >
            <thead>
              <tr>
                <th
                  style="
                    background-color: #3498db;
                    color: white;
                    padding: 1rem;
                    text-align: left;
                    width: 60%;
                  "
                >
                  指令 (Instruction)
                </th>
                <th
                  style="
                    background-color: #3498db;
                    color: white;
                    padding: 1rem;
                    text-align: left;
                    width: 40%;
                  "
                >
                  預期回應 (Expected Response)
                </th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td
                  style="
                    padding: 1rem;
                    border-bottom: 1px solid #eee;
                    background-color: #f8f9fa;
                  "
                >
                  <div style="display: flex; align-items: center">
                    <span style="font-size: 1.1rem"
                      >Convert 45 kilometers to meters.</span
                    >
                  </div>
                </td>
                <td
                  style="
                    padding: 1rem;
                    border-bottom: 1px solid #eee;
                    background-color: #f8f9fa;
                  "
                >
                  <div style="display: flex; align-items: center">
                    <span style="font-size: 1.1rem">45000 meters</span>
                  </div>
                </td>
              </tr>
              <tr>
                <td style="padding: 1rem; border-bottom: 1px solid #eee">
                  <div style="display: flex; align-items: center">
                    <span style="font-size: 1.1rem"
                      >Provide a synonym for "bright."</span
                    >
                  </div>
                </td>
                <td style="padding: 1rem; border-bottom: 1px solid #eee">
                  <div style="display: flex; align-items: center">
                    <span style="font-size: 1.1rem">radiant</span>
                  </div>
                </td>
              </tr>
              <tr>
                <td style="padding: 1rem; background-color: #f8f9fa">
                  <div style="display: flex; align-items: center">
                    <span style="font-size: 1.1rem"
                      >Edit sentence to remove passive voice: "The song was
                      composed by the artist."</span
                    >
                  </div>
                </td>
                <td style="padding: 1rem; background-color: #f8f9fa">
                  <div style="display: flex; align-items: center">
                    <span style="font-size: 1.1rem"
                      >The artist composed the song.</span
                    >
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div
          style="
            margin-top: 1.5rem;
            background-color: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid #e74c3c;
          "
        >
          <p style="font-size: 1.2rem; margin: 0">
            <span style="font-size: 1.5rem; margin-right: 0.5rem">💡</span>
            這些範例展示了模型如何從單純的文本生成轉變為能夠理解並執行特定指令的能力。
          </p>
        </div>
      </div>
    </div>

    <!-- Slide 5: Fine-tuning Process -->
    <div class="slide">
      <div class="slide-content">
        <h2><span class="emoji">⚙️</span>Instruction fine-tuning 三階段流程</h2>

        <div style="display: flex; flex-direction: column; gap: 1.5rem">
          <div
            style="
              background-color: #f8f9fa;
              padding: 1rem;
              border-radius: 8px;
              border-left: 4px solid #3498db;
              margin-bottom: 1rem;
            "
          >
            <p style="font-size: 1.2rem; margin: 0">
              Instruction fine-tuning
              是一個三階段的流程，從資料準備到模型評估，每個階段都有明確的目標和任務。
            </p>
          </div>

          <div style="display: flex; gap: 2rem; align-items: flex-start">
            <div style="flex: 2">
              <img
                src="images/fig7_3.PNG"
                alt="Instruction fine-tuning 三階段流程"
                style="
                  width: 100%;
                  height: auto;
                  border-radius: 8px;
                  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
                "
              />
            </div>

            <div
              style="flex: 1; display: flex; flex-direction: column; gap: 1rem"
            >
              <div
                style="
                  background-color: #f8f9fa;
                  padding: 1.2rem 1rem 0rem 1rem;
                  border-radius: 8px;
                  border-left: 4px solid #3498db;
                  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                "
              >
                <h3
                  style="
                    color: #3498db;
                    margin-top: 0;
                    display: flex;
                    align-items: center;
                  "
                >
                  <span style="font-size: 1.5rem; margin-right: 0.5rem">📊</span
                  >Stage 1: 準備資料集
                </h3>
                <ol
                  style="
                    margin-left: 1.5rem;
                    margin-top: 0.8rem;
                    font-size: 0.9rem;
                  "
                >
                  <li style="margin-bottom: 0.5rem">資料下載與格式整理</li>
                  <li style="margin-bottom: 0.5rem">批次化（Batching）</li>
                  <li>建立 DataLoader</li>
                </ol>
              </div>

              <div
                style="
                  background-color: #f8f9fa;
                  padding: 1.2rem 1rem 0rem 1rem;
                  border-radius: 8px;
                  border-left: 4px solid #e74c3c;
                  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                "
              >
                <h3
                  style="
                    color: #e74c3c;
                    margin-top: 0;
                    display: flex;
                    align-items: center;
                  "
                >
                  <span style="font-size: 1.5rem; margin-right: 0.5rem">🔄</span
                  >Stage 2: 微調模型
                </h3>
                <ol
                  style="
                    margin-left: 1.5rem;
                    margin-top: 0.8rem;
                    font-size: 0.9rem;
                  "
                >
                  <li style="margin-bottom: 0.5rem">載入預訓練模型</li>
                  <li style="margin-bottom: 0.5rem">
                    微調 LLM（使用指令資料集）
                  </li>
                  <li>觀察 loss</li>
                </ol>
              </div>

              <div
                style="
                  background-color: #f8f9fa;
                  padding: 1.2rem 1rem 0rem 1rem;
                  border-radius: 8px;
                  border-left: 4px solid #2ecc71;
                  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                "
              >
                <h3
                  style="
                    color: #2ecc71;
                    margin-top: 0;
                    display: flex;
                    align-items: center;
                  "
                >
                  <span style="font-size: 1.5rem; margin-right: 0.5rem">📈</span
                  >Stage 3: 模型評估
                </h3>
                <ol
                  style="
                    margin-left: 1.5rem;
                    margin-top: 0.8rem;
                    font-size: 0.9rem;
                  "
                >
                  <li style="margin-bottom: 0.5rem">擷取回應</li>
                  <li style="margin-bottom: 0.5rem">質性分析</li>
                  <li>評分</li>
                </ol>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Slide 6: Code Example -->
    <div class="slide">
      <div class="slide-content">
        <h2><span class="emoji">💻</span>簡易指令微調程式碼</h2>
        <pre><code class="language-python">from transformers import AutoTokenizer, AutoModelForCausalLM, Trainer, TrainingArguments, DataCollatorForSeq2Seq
from datasets import load_dataset

# 下載 tokenizer 與模型
model_name = "gpt2"
tokenizer = AutoTokenizer.from_pretrained(model_name)
model = AutoModelForCausalLM.from_pretrained(model_name)

# 假設你有指令資料集 (instruction + response)
dataset = load_dataset("json", data_files="instruction_dataset.json")

# 資料格式轉換
def preprocess(example):
    prompt = f"Instruction: {example['instruction']}\nResponse:"
    inputs = tokenizer(prompt, truncation=True, padding="max_length", max_length=512)
    labels = tokenizer(example['response'], truncation=True, padding="max_length", max_length=512)
    inputs["labels"] = labels["input_ids"]
    return inputs

tokenized_dataset = dataset.map(preprocess)

# 訓練設定
training_args = TrainingArguments(
    output_dir="./results",
    per_device_train_batch_size=2,
    num_train_epochs=3,
    logging_dir="./logs",
    save_strategy="epoch"
)

# Trainer 初始化
trainer = Trainer(
    model=model,
    args=training_args,
    train_dataset=tokenized_dataset["train"],
    tokenizer=tokenizer,
    data_collator=DataCollatorForSeq2Seq(tokenizer, model=model)
)

# 開始訓練
trainer.train()</code></pre>
      </div>
    </div>

    <!-- Slide 7: Data Download -->
    <div class="slide">
      <div class="slide-content">
        <h2><span class="emoji">🌐</span>資料下載方式</h2>
        <h3>下載資料集：</h3>
        <pre><code class="language-python">import json, os, urllib.request
      
      def download_and_load_file(file_path, url):
          if not os.path.exists(file_path):
              with urllib.request.urlopen(url) as response:
                  text_data = response.read().decode("utf-8")
                  with open(file_path, "w", encoding="utf-8") as file:
                      file.write(text_data)
          with open(file_path, "r", encoding="utf-8") as file:
              text_data = file.read()
              data = json.loads(text_data)
          return data
      
      file_path = "instruction-data.json"
      url = "https://raw.githubusercontent.com/rasbt/LLMs-from-scratch/main/ch07/01_main-chapter-code/instruction-data.json"
      
      data = download_and_load_file(file_path, url)
      print("Number of entries:", len(data))</code></pre>
      </div>
    </div>

    <!-- Slide 8: Data Format -->
    <div class="slide">
      <div class="slide-content">
        <h2><span class="emoji">📦</span>資料集格式</h2>

        <div style="display: flex; flex-direction: column; gap: 1.5rem">
          <div
            style="
              background-color: #f8f9fa;
              padding: 1rem;
              border-radius: 8px;
              border-left: 4px solid #3498db;
            "
          >
            <p style="font-size: 1.2rem; margin: 0">
              每筆資料是 JSON 格式的字典，包含以下欄位：
            </p>
          </div>

          <div style="display: flex; flex-direction: column; gap: 1.5rem">
            <div
              style="
                flex: 1;
                background-color: #f8f9fa;
                padding: 1.2rem;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
              "
            >
              <h3
                style="
                  color: #3498db;
                  margin-top: 0;
                  display: flex;
                  align-items: center;
                "
              >
                <span style="font-size: 1.5rem; margin-right: 0.5rem">📝</span
                >基本格式
              </h3>
              <pre
                style="
                  margin-top: 1rem;
                  background-color: #282c34;
                  border-radius: 6px;
                "
              ><code class="language-json">{
  "instruction": "Identify the correct spelling of the following word.",
  "input": "Occasion",
  "output": "The correct spelling is 'Occasion.'"
}</code></pre>
            </div>

            <div
              style="
                flex: 1;
                background-color: #f8f9fa;
                padding: 1.2rem;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
              "
            >
              <h3
                style="
                  color: #e74c3c;
                  margin-top: 0;
                  display: flex;
                  align-items: center;
                "
              >
                <span style="font-size: 1.5rem; margin-right: 0.5rem">💡</span
                >空輸入範例
              </h3>
              <pre
                style="
                  margin-top: 1rem;
                  background-color: #282c34;
                  border-radius: 6px;
                "
              ><code class="language-json">{
  "instruction": "What is an antonym of 'complicated'?",
  "input": "",
  "output": "An antonym of 'complicated' is 'simple.'"
}</code></pre>
            </div>
          </div>

          <div
            style="
              background-color: #f8f9fa;
              padding: 1rem;
              border-radius: 8px;
              border-left: 4px solid #2ecc71;
            "
          >
            <p style="font-size: 1.2rem; margin: 0">
              <span style="font-size: 1.5rem; margin-right: 0.5rem">💡</span>
              注意：<code>input</code>
              欄位可能為空字串，這表示指令本身已包含足夠資訊，無需額外輸入。
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Slide 9: Prompt Format -->
    <div class="slide">
      <div class="slide-content">
        <h2><span class="emoji">🧾</span>Prompt 格式轉換</h2>

        <div style="display: flex; flex-direction: column; gap: 1.5rem">
          <div
            style="
              background-color: #f8f9fa;
              padding: 1rem;
              border-radius: 8px;
              border-left: 4px solid #3498db;
            "
          >
            <h3
              style="
                color: #3498db;
                margin-top: 0;
                display: flex;
                align-items: center;
              "
            >
              <span style="font-size: 1.5rem; margin-right: 0.5rem">🔧</span
              >為什麼需要轉換格式？
            </h3>
            <p style="font-size: 1.2rem; margin: 0.5rem 0">
              將 prompt 轉換成特定格式（如 Alpaca 或 Phi-3）主要是為了：
            </p>
            <div
              style="
                display: flex;
                flex-direction: column;
                gap: 0.8rem;
                margin-top: 1rem;
              "
            >
              <div
                style="
                  background-color: white;
                  padding: 0.8rem;
                  border-radius: 6px;
                  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                "
              >
                <h4
                  style="
                    color: #3498db;
                    margin: 0 0 0.5rem 0;
                    display: flex;
                    align-items: center;
                  "
                >
                  <span style="font-size: 1.2rem; margin-right: 0.5rem">1️⃣</span
                  >符合模型訓練時的格式期望
                </h4>
                <p style="margin: 0; font-size: 1.1rem">
                  保持與原始訓練時的一致性，讓模型更容易理解指令意圖
                </p>
              </div>

              <div
                style="
                  background-color: white;
                  padding: 0.8rem;
                  border-radius: 6px;
                  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                "
              >
                <h4
                  style="
                    color: #e74c3c;
                    margin: 0 0 0.5rem 0;
                    display: flex;
                    align-items: center;
                  "
                >
                  <span style="font-size: 1.2rem; margin-right: 0.5rem">2️⃣</span
                  >提高微調效果
                </h4>
                <p style="margin: 0; font-size: 1.1rem">
                  加快收斂速度，避免模型誤解 prompt 意圖，提升產出品質
                </p>
              </div>

              <div
                style="
                  background-color: white;
                  padding: 0.8rem;
                  border-radius: 6px;
                  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                "
              >
                <h4
                  style="
                    color: #2ecc71;
                    margin: 0 0 0.5rem 0;
                    display: flex;
                    align-items: center;
                  "
                >
                  <span style="font-size: 1.2rem; margin-right: 0.5rem">3️⃣</span
                  >標準化資料處理流程
                </h4>
                <p style="margin: 0; font-size: 1.1rem">
                  方便使用開源框架（如 HuggingFace Transformers、LoRA
                  微調工具等）
                </p>
              </div>
            </div>
          </div>

          <div style="display: flex; flex-direction: column; gap: 1.5rem">
            <div
              style="
                flex: 1;
                background-color: #f8f9fa;
                padding: 1.2rem;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
              "
            >
              <h3
                style="
                  color: #3498db;
                  margin-top: 0;
                  display: flex;
                  align-items: center;
                "
              >
                <span style="font-size: 1.5rem; margin-right: 0.5rem">📝</span
                >Alpaca 風格
              </h3>
              <div
                style="
                  background-color: white;
                  padding: 0.8rem;
                  border-radius: 6px;
                  margin-bottom: 0.8rem;
                "
              >
                <p style="margin: 0; font-size: 1.1rem; color: #666">
                  基於 Stanford Alpaca 的微調資料集格式
                </p>
              </div>
              <pre
                style="
                  margin-top: 0.5rem;
                  background-color: #282c34;
                  border-radius: 6px;
                "
              ><code class="language-text">Below is an instruction that describes a task. Write a response that appropriately completes the request.

### Instruction:
Identify the correct spelling of the following word.

### Input:
Occasion

### Response:
The correct spelling is 'Occasion.'</code></pre>
            </div>

            <div
              style="
                flex: 1;
                background-color: #f8f9fa;
                padding: 1.2rem;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
              "
            >
              <h3
                style="
                  color: #e74c3c;
                  margin-top: 0;
                  display: flex;
                  align-items: center;
                "
              >
                <span style="font-size: 1.5rem; margin-right: 0.5rem">💬</span
                >Phi-3 風格（簡潔版）
              </h3>
              <div
                style="
                  background-color: white;
                  padding: 0.8rem;
                  border-radius: 6px;
                  margin-bottom: 0.8rem;
                "
              >
                <p style="margin: 0; font-size: 1.1rem; color: #666">
                  Microsoft 的 Phi-3 使用類似 OpenAI 的聊天格式
                </p>
              </div>
              <pre
                style="
                  margin-top: 0.5rem;
                  background-color: #282c34;
                  border-radius: 6px;
                "
              ><code class="language-text">&lt;|user|&gt;
Identify the correct spelling of the following word: Occasion
&lt;|assistant|&gt;
The correct spelling is 'Occasion.'</code></pre>
            </div>
          </div>

          <div
            style="
              background-color: #f8f9fa;
              padding: 1rem;
              border-radius: 8px;
              border-left: 4px solid #2ecc71;
            "
          >
            <h3
              style="
                color: #2ecc71;
                margin-top: 0;
                display: flex;
                align-items: center;
              "
            >
              <span style="font-size: 1.5rem; margin-right: 0.5rem">📊</span
              >格式選擇建議
            </h3>
            <table
              style="
                width: 100%;
                margin-top: 0.5rem;
                border-collapse: separate;
                border-spacing: 0;
                border-radius: 6px;
                overflow: hidden;
              "
            >
              <thead>
                <tr>
                  <th
                    style="
                      width: 30%;
                      background-color: #2ecc71;
                      color: white;
                      padding: 0.8rem;
                    "
                  >
                    模型
                  </th>
                  <th
                    style="
                      width: 30%;
                      background-color: #2ecc71;
                      color: white;
                      padding: 0.8rem;
                    "
                  >
                    建議格式
                  </th>
                  <th
                    style="
                      width: 40%;
                      background-color: #2ecc71;
                      color: white;
                      padding: 0.8rem;
                    "
                  >
                    適用場景
                  </th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td style="padding: 0.8rem; background-color: white">
                    Alpaca
                  </td>
                  <td style="padding: 0.8rem; background-color: white">
                    <code>instruction</code>/<code>input</code>/<code
                      >output</code
                    >
                  </td>
                  <td style="padding: 0.8rem; background-color: white">
                    單輪指令任務
                  </td>
                </tr>
                <tr>
                  <td style="padding: 0.8rem; background-color: #f8f9fa">
                    Phi-3
                  </td>
                  <td style="padding: 0.8rem; background-color: #f8f9fa">
                    <code>messages</code> (chat 格式)
                  </td>
                  <td style="padding: 0.8rem; background-color: #f8f9fa">
                    多輪對話與更自然語境任務
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Slide 10: Format Input Function -->
    <div class="slide">
      <div class="slide-content">
        <h2><span class="emoji">🔧</span>Prompt 格式化函數</h2>
        <h3>format_input 函數：</h3>
        <pre><code class="language-python">def format_input(entry):
    instruction_text = (
        f"Below is an instruction that describes a task. "
        f"Write a response that appropriately completes the request.\n"
        f"\n### Instruction:\n{entry['instruction']}"
    )
    
    input_text = f"\n\n### Input:\n{entry['input']}" if entry["input"] else ""
    return instruction_text + input_text</code></pre>

        <h3>用法：</h3>
        <pre><code class="language-python">model_input = format_input(data[50])
desired_response = f"\n\n### Response:\n{data[50]['output']}"
print(model_input + desired_response)</code></pre>

        <h3>輸出結果：</h3>
        <pre><code class="language-text">Below is an instruction that describes a task. Write a response that appropriately completes the request.

### Instruction:
Identify the correct spelling of the following word.

### Input:
Occasion

### Response:
The correct spelling is 'Occasion.'</code></pre>
      </div>
    </div>

    <!-- Slide 11: Data Splitting -->
    <div class="slide">
      <div class="slide-content">
        <h2><span class="emoji">🔢</span>資料集切割</h2>

        <div style="display: flex; flex-direction: column; gap: 1.5rem">
          <div
            style="
              background-color: #f8f9fa;
              padding: 1rem;
              border-radius: 8px;
              border-left: 4px solid #3498db;
            "
          >
            <h3
              style="
                color: #3498db;
                margin-top: 0;
                display: flex;
                align-items: center;
              "
            >
              <span style="font-size: 1.5rem; margin-right: 0.5rem">📊</span
              >資料分割比例
            </h3>
            <div
              style="
                display: flex;
                justify-content: space-between;
                gap: 1rem;
                margin-top: 1rem;
              "
            >
              <div
                style="
                  flex: 1;
                  background-color: white;
                  padding: 1rem;
                  border-radius: 6px;
                  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                  text-align: center;
                "
              >
                <h4 style="color: #3498db; margin: 0 0 0.5rem 0">訓練集</h4>
                <div style="font-size: 2rem; font-weight: bold; color: #3498db">
                  85%
                </div>
                <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem; color: #666">
                  用於模型訓練
                </p>
              </div>

              <div
                style="
                  flex: 1;
                  background-color: white;
                  padding: 1rem;
                  border-radius: 6px;
                  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                  text-align: center;
                "
              >
                <h4 style="color: #e74c3c; margin: 0 0 0.5rem 0">驗證集</h4>
                <div style="font-size: 2rem; font-weight: bold; color: #e74c3c">
                  5%
                </div>
                <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem; color: #666">
                  用於調整超參數
                </p>
              </div>

              <div
                style="
                  flex: 1;
                  background-color: white;
                  padding: 1rem;
                  border-radius: 6px;
                  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                  text-align: center;
                "
              >
                <h4 style="color: #2ecc71; margin: 0 0 0.5rem 0">測試集</h4>
                <div style="font-size: 2rem; font-weight: bold; color: #2ecc71">
                  10%
                </div>
                <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem; color: #666">
                  用於最終評估
                </p>
              </div>
            </div>
          </div>

          <div
            style="
              background-color: #f8f9fa;
              padding: 1rem;
              border-radius: 8px;
              border-left: 4px solid #e74c3c;
            "
          >
            <h3
              style="
                color: #e74c3c;
                margin-top: 0;
                display: flex;
                align-items: center;
              "
            >
              <span style="font-size: 1.5rem; margin-right: 0.5rem">💻</span
              >資料分割程式碼
            </h3>
            <div
              style="
                background-color: white;
                padding: 0.8rem;
                border-radius: 6px;
                margin-bottom: 0.8rem;
              "
            >
              <p style="margin: 0; font-size: 1.1rem; color: #666">
                使用 Python 進行資料集切割
              </p>
            </div>
            <pre
              style="
                margin-top: 0.5rem;
                background-color: #282c34;
                border-radius: 6px;
              "
            ><code class="language-python">train_portion = int(len(data) * 0.85)
test_portion = int(len(data) * 0.1)
val_portion = len(data) - train_portion - test_portion

train_data = data[:train_portion]
test_data = data[train_portion:train_portion + test_portion]
val_data = data[train_portion + test_portion:]

print("Training set length:", len(train_data))
print("Validation set length:", len(val_data))
print("Test set length:", len(test_data))</code></pre>
          </div>

          <!-- <div
            style="
              background-color: #f8f9fa;
              padding: 1rem;
              border-radius: 8px;
              border-left: 4px solid #2ecc71;
            "
          >
            <h3
              style="
                color: #2ecc71;
                margin-top: 0;
                display: flex;
                align-items: center;
              "
            >
              <span style="font-size: 1.5rem; margin-right: 0.5rem">📝</span
              >分割注意事項
            </h3>
            <div
              style="
                display: flex;
                flex-direction: column;
                gap: 0.8rem;
                margin-top: 1rem;
              "
            >
              <div
                style="
                  background-color: white;
                  padding: 0.8rem;
                  border-radius: 6px;
                  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                "
              >
                <h4
                  style="
                    color: #2ecc71;
                    margin: 0 0 0.5rem 0;
                    display: flex;
                    align-items: center;
                  "
                >
                  <span style="font-size: 1.2rem; margin-right: 0.5rem">1️⃣</span
                  >隨機性
                </h4>
                <p style="margin: 0; font-size: 1.1rem">
                  確保資料集在分割前已經隨機打亂，避免資料分布不均
                </p>
              </div>

              <div
                style="
                  background-color: white;
                  padding: 0.8rem;
                  border-radius: 6px;
                  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                "
              >
                <h4
                  style="
                    color: #2ecc71;
                    margin: 0 0 0.5rem 0;
                    display: flex;
                    align-items: center;
                  "
                >
                  <span style="font-size: 1.2rem; margin-right: 0.5rem">2️⃣</span
                  >比例選擇
                </h4>
                <p style="margin: 0; font-size: 1.1rem">
                  根據資料集大小和任務需求調整分割比例，小資料集可能需要更大的驗證/測試集比例
                </p>
              </div>

              <div
                style="
                  background-color: white;
                  padding: 0.8rem;
                  border-radius: 6px;
                  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                "
              >
                <h4
                  style="
                    color: #2ecc71;
                    margin: 0 0 0.5rem 0;
                    display: flex;
                    align-items: center;
                  "
                >
                  <span style="font-size: 1.2rem; margin-right: 0.5rem">3️⃣</span
                  >資料平衡
                </h4>
                <p style="margin: 0; font-size: 1.1rem">
                  確保各類別在訓練、驗證和測試集中都有適當的代表性
                </p>
              </div>
            </div>
          </div> -->
        </div>
      </div>
    </div>

    <!-- Slide 12: Organizing Data into Training Batches -->
    <div class="slide">
      <div class="slide-content">
        <h2>
          <span class="emoji">📦</span>7.3 重點整理：Organizing Data into
          Training Batches
        </h2>

        <div style="display: flex; flex-direction: column; gap: 1.5rem">
          <div
            style="
              background-color: #f8f9fa;
              padding: 1.5rem;
              border-radius: 8px;
              border-left: 4px solid #3498db;
            "
          >
            <h3
              style="
                color: #3498db;
                margin-top: 0;
                display: flex;
                align-items: center;
              "
            >
              <span style="font-size: 1.5rem; margin-right: 0.5rem">🎯</span
              >主要目標
            </h3>
            <p style="font-size: 1.1rem; line-height: 1.5">
              將 instruction dataset 中的多筆樣本組合成訓練
              batches，並製作對應的
              <strong style="color: #3498db">input token IDs</strong> 和
              <strong style="color: #e74c3c">target token IDs</strong
              >，讓模型學習輸出預期結果。
            </p>
          </div>

          <div
            style="
              background-color: #f8f9fa;
              padding: 1.5rem;
              border-radius: 8px;
              border-left: 4px solid #2ecc71;
            "
          >
            <h3
              style="
                color: #2ecc71;
                margin-top: 0;
                display: flex;
                align-items: center;
              "
            >
              <span style="font-size: 1.5rem; margin-right: 0.5rem">🔄</span
              >處理流程
            </h3>
            <div
              style="
                display: flex;
                flex-direction: column;
                gap: 1rem;
                margin-top: 1rem;
              "
            >
              <div style="display: flex; align-items: flex-start; gap: 1rem">
                <div
                  style="
                    background-color: #2ecc71;
                    color: white;
                    width: 30px;
                    height: 30px;
                    border-radius: 50%;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    font-weight: bold;
                    flex-shrink: 0;
                  "
                >
                  1
                </div>
                <div
                  style="
                    background-color: white;
                    padding: 1rem;
                    border-radius: 6px;
                    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                    flex-grow: 1;
                  "
                >
                  <h4 style="color: #2ecc71; margin: 0 0 0.5rem 0">資料準備</h4>
                  <p style="margin: 0; font-size: 1.1rem">
                    從資料集中提取指令、輸入和輸出文本
                  </p>
                </div>
              </div>

              <div style="display: flex; align-items: flex-start; gap: 1rem">
                <div
                  style="
                    background-color: #2ecc71;
                    color: white;
                    width: 30px;
                    height: 30px;
                    border-radius: 50%;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    font-weight: bold;
                    flex-shrink: 0;
                  "
                >
                  2
                </div>
                <div
                  style="
                    background-color: white;
                    padding: 1rem;
                    border-radius: 6px;
                    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                    flex-grow: 1;
                  "
                >
                  <h4 style="color: #2ecc71; margin: 0 0 0.5rem 0">格式轉換</h4>
                  <p style="margin: 0; font-size: 1.1rem">
                    將文本轉換為模型所需的特定格式（如Alpaca或Phi-3格式）
                  </p>
                </div>
              </div>

              <div style="display: flex; align-items: flex-start; gap: 1rem">
                <div
                  style="
                    background-color: #2ecc71;
                    color: white;
                    width: 30px;
                    height: 30px;
                    border-radius: 50%;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    font-weight: bold;
                    flex-shrink: 0;
                  "
                >
                  3
                </div>
                <div
                  style="
                    background-color: white;
                    padding: 1rem;
                    border-radius: 6px;
                    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                    flex-grow: 1;
                  "
                >
                  <h4 style="color: #2ecc71; margin: 0 0 0.5rem 0">分詞處理</h4>
                  <p style="margin: 0; font-size: 1.1rem">
                    使用tokenizer將文本轉換為token IDs
                  </p>
                </div>
              </div>

              <div style="display: flex; align-items: flex-start; gap: 1rem">
                <div
                  style="
                    background-color: #2ecc71;
                    color: white;
                    width: 30px;
                    height: 30px;
                    border-radius: 50%;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    font-weight: bold;
                    flex-shrink: 0;
                  "
                >
                  4
                </div>
                <div
                  style="
                    background-color: white;
                    padding: 1rem;
                    border-radius: 6px;
                    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                    flex-grow: 1;
                  "
                >
                  <h4 style="color: #2ecc71; margin: 0 0 0.5rem 0">批次組裝</h4>
                  <p style="margin: 0; font-size: 1.1rem">
                    將多個樣本組合成固定大小的訓練批次
                  </p>
                </div>
              </div>

              <div style="display: flex; align-items: flex-start; gap: 1rem">
                <div
                  style="
                    background-color: #2ecc71;
                    color: white;
                    width: 30px;
                    height: 30px;
                    border-radius: 50%;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    font-weight: bold;
                    flex-shrink: 0;
                  "
                >
                  5
                </div>
                <div
                  style="
                    background-color: white;
                    padding: 1rem;
                    border-radius: 6px;
                    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                    flex-grow: 1;
                  "
                >
                  <h4 style="color: #2ecc71; margin: 0 0 0.5rem 0">準備目標</h4>
                  <p style="margin: 0; font-size: 1.1rem">
                    為每個批次準備對應的目標token IDs，用於監督學習
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Slide 13: Batching Five Steps -->
    <div class="slide">
      <div class="slide-content">
        <h2><span class="emoji">🔁</span>Batching 五步驟</h2>

        <div
          style="
            background-color: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            border-left: 4px solid #e74c3c;
          "
        >
          <h3
            style="
              color: #e74c3c;
              margin-top: 0;
              display: flex;
              align-items: center;
            "
          >
            <span style="font-size: 1.5rem; margin-right: 0.5rem">💡</span
            >重要說明
          </h3>
          <p style="font-size: 1.1rem; line-height: 1.5">
            在監督式微調中，我們希望模型能夠根據輸入生成正確的輸出。通過將輸入序列右移一格作為目標序列，模型學習預測下一個token，這是自迴歸語言模型的核心訓練方式。
          </p>
        </div>

        <div style="display: flex; gap: 2rem; margin-top: 1.5rem">
          <!-- 左侧图片 -->
          <div
            style="
              flex: 2;
              display: flex;
              flex-direction: column;
              align-items: center;
            "
          >
            <div
              style="
                background-color: #f8f9fa;
                padding: 1rem;
                border-radius: 8px;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
                width: 100%;
              "
            >
              <img
                src="images/fig7_6.PNG"
                alt="Batching 五步驟"
                style="width: 100%; border-radius: 4px"
              />
            </div>
            <p
              style="
                margin-top: 0.8rem;
                font-size: 0.9rem;
                color: #666;
                text-align: center;
              "
            >
              圖7.6: Batching處理流程圖
            </p>
          </div>

          <!-- 右侧说明文字 -->
          <div
            style="flex: 1; display: flex; flex-direction: column; gap: 1rem"
          >
            <div
              style="
                background-color: #f8f9fa;
                padding: 1.5rem;
                border-radius: 8px;
                border-left: 4px solid #3498db;
              "
            >
              <h3
                style="
                  color: #3498db;
                  margin-top: 0;
                  display: flex;
                  align-items: center;
                "
              >
                <span style="font-size: 1.5rem; margin-right: 0.5rem">📝</span
                >Batching處理步驟
              </h3>
              <div
                style="
                  display: flex;
                  flex-direction: column;
                  gap: 1rem;
                  margin-top: 1rem;
                "
              >
                <div style="display: flex; align-items: flex-start; gap: 1rem">
                  <div
                    style="
                      background-color: #3498db;
                      color: white;
                      width: 30px;
                      height: 30px;
                      border-radius: 50%;
                      display: flex;
                      justify-content: center;
                      align-items: center;
                      font-weight: bold;
                      flex-shrink: 0;
                    "
                  >
                    1
                  </div>
                  <div
                    style="
                      background-color: white;
                      padding: 1rem;
                      border-radius: 6px;
                      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                      flex-grow: 1;
                    "
                  >
                    <h4 style="color: #3498db; margin: 0 0 0.5rem 0">
                      格式化輸入文字
                    </h4>
                    <p style="margin: 0; font-size: 1.1rem">
                      instruction + input + response（用template拼接）
                    </p>
                  </div>
                </div>

                <div style="display: flex; align-items: flex-start; gap: 1rem">
                  <div
                    style="
                      background-color: #3498db;
                      color: white;
                      width: 30px;
                      height: 30px;
                      border-radius: 50%;
                      display: flex;
                      justify-content: center;
                      align-items: center;
                      font-weight: bold;
                      flex-shrink: 0;
                    "
                  >
                    2
                  </div>
                  <div
                    style="
                      background-color: white;
                      padding: 1rem;
                      border-radius: 6px;
                      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                      flex-grow: 1;
                    "
                  >
                    <h4 style="color: #3498db; margin: 0 0 0.5rem 0">
                      Tokenizer編碼文字
                    </h4>
                    <p style="margin: 0; font-size: 1.1rem">
                      將文本轉換為token IDs序列
                    </p>
                  </div>
                </div>

                <div style="display: flex; align-items: flex-start; gap: 1rem">
                  <div
                    style="
                      background-color: #3498db;
                      color: white;
                      width: 30px;
                      height: 30px;
                      border-radius: 50%;
                      display: flex;
                      justify-content: center;
                      align-items: center;
                      font-weight: bold;
                      flex-shrink: 0;
                    "
                  >
                    3
                  </div>
                  <div
                    style="
                      background-color: white;
                      padding: 1rem;
                      border-radius: 6px;
                      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                      flex-grow: 1;
                    "
                  >
                    <h4 style="color: #3498db; margin: 0 0 0.5rem 0">
                      補齊padding
                    </h4>
                    <p style="margin: 0; font-size: 1.1rem">
                      使用50256 (<code>&lt;|endoftext|&gt;</code>) 作為padding
                      token
                    </p>
                  </div>
                </div>

                <div style="display: flex; align-items: flex-start; gap: 1rem">
                  <div
                    style="
                      background-color: #3498db;
                      color: white;
                      width: 30px;
                      height: 30px;
                      border-radius: 50%;
                      display: flex;
                      justify-content: center;
                      align-items: center;
                      font-weight: bold;
                      flex-shrink: 0;
                    "
                  >
                    4
                  </div>
                  <div
                    style="
                      background-color: white;
                      padding: 1rem;
                      border-radius: 6px;
                      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                      flex-grow: 1;
                    "
                  >
                    <h4 style="color: #3498db; margin: 0 0 0.5rem 0">
                      製作target tokens
                    </h4>
                    <p style="margin: 0; font-size: 1.1rem">
                      對input IDs右移一格 + 結尾加padding
                    </p>
                  </div>
                </div>

                <div style="display: flex; align-items: flex-start; gap: 1rem">
                  <div
                    style="
                      background-color: #3498db;
                      color: white;
                      width: 30px;
                      height: 30px;
                      border-radius: 50%;
                      display: flex;
                      justify-content: center;
                      align-items: center;
                      font-weight: bold;
                      flex-shrink: 0;
                    "
                  >
                    5
                  </div>
                  <div
                    style="
                      background-color: white;
                      padding: 1rem;
                      border-radius: 6px;
                      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                      flex-grow: 1;
                    "
                  >
                    <h4 style="color: #3498db; margin: 0 0 0.5rem 0">
                      轉換padding tokens
                    </h4>
                    <p style="margin: 0; font-size: 1.1rem">
                      將padding tokens轉為-100，被PyTorch忽略
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Slide 14: Ignoring -100 -->
    <div class="slide">
      <div class="slide-content">
        <h2><span class="emoji">🎯</span>ignore_index=-100 的用途與策略</h2>

        <div
          style="
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            margin-top: 1.5rem;
          "
        >
          <div
            style="
              background-color: #f8f9fa;
              padding: 1.5rem;
              border-radius: 8px;
              border-left: 4px solid #3498db;
            "
          >
            <h3
              style="
                color: #3498db;
                margin-top: 0;
                display: flex;
                align-items: center;
              "
            >
              <span style="font-size: 1.5rem; margin-right: 0.5rem">🔍</span
              >PyTorch 預設參數
            </h3>
            <div
              style="
                background-color: white;
                padding: 1rem;
                border-radius: 6px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                margin-top: 1rem;
              "
            >
              <div style="display: flex; align-items: flex-start; gap: 0.5rem">
                <span style="font-size: 1.2rem; color: #3498db">📌</span>
                <pre
                  style="
                    margin: 0;
                    background-color: #282c34;
                    border-radius: 6px;
                    padding: 0.8rem;
                  "
                ><code class="language-python">torch.nn.functional.cross_entropy(
    input, target, weight=None, size_average=None, 
    ignore_index=-100, reduce=None, reduction='mean'
)</code></pre>
              </div>
            </div>
          </div>

          <div
            style="
              background-color: #f8f9fa;
              padding: 1.5rem;
              border-radius: 8px;
              border-left: 4px solid #2ecc71;
            "
          >
            <h3
              style="
                color: #2ecc71;
                margin-top: 0;
                display: flex;
                align-items: center;
              "
            >
              <span style="font-size: 1.5rem; margin-right: 0.5rem">🎯</span
              >忽略 -100 的目的
            </h3>
            <div
              style="
                display: flex;
                flex-direction: column;
                gap: 1rem;
                margin-top: 1rem;
              "
            >
              <div
                style="
                  background-color: white;
                  padding: 1rem;
                  border-radius: 6px;
                  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                "
              >
                <h4
                  style="
                    color: #2ecc71;
                    margin: 0 0 0.5rem 0;
                    display: flex;
                    align-items: center;
                  "
                >
                  <span style="font-size: 1.2rem; margin-right: 0.5rem">1️⃣</span
                  >跳過 padding tokens
                </h4>
                <p style="margin: 0; font-size: 1.1rem">
                  在計算 loss 時，我們不希望模型學習預測 padding
                  tokens，因此將它們標記為 -100，使其不參與 loss 計算。
                </p>
              </div>

              <div
                style="
                  background-color: white;
                  padding: 1rem;
                  border-radius: 6px;
                  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                "
              >
                <h4
                  style="
                    color: #2ecc71;
                    margin: 0 0 0.5rem 0;
                    display: flex;
                    align-items: center;
                  "
                >
                  <span style="font-size: 1.2rem; margin-right: 0.5rem">2️⃣</span
                  >可選：跳過 instruction/input tokens
                </h4>
                <p style="margin: 0; font-size: 1.1rem">
                  在某些情況下，我們可能只想讓模型學習預測 response
                  部分，而不學習預測 instruction 和 input 部分。
                </p>
              </div>
            </div>
          </div>

          <div
            style="
              background-color: #f8f9fa;
              padding: 1.5rem;
              border-radius: 8px;
              border-left: 4px solid #e74c3c;
            "
          >
            <h3
              style="
                color: #e74c3c;
                margin-top: 0;
                display: flex;
                align-items: center;
              "
            >
              <span style="font-size: 1.5rem; margin-right: 0.5rem">⚠️</span
              >特殊處理：token ID 50256
            </h3>
            <div
              style="
                background-color: white;
                padding: 1rem;
                border-radius: 6px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                margin-top: 1rem;
              "
            >
              <p style="margin: 0; font-size: 1.1rem">
                在 GPT-2 中，token ID 50256 是
                <code>&lt;|endoftext|&gt;</code> token，我們將其用作 padding
                token。在 target 序列中，我們將除了第一個以外的所有 padding
                tokens 標記為 -100，這樣模型就不會學習預測它們。
              </p>
            </div>
          </div>

          <div
            style="
              background-color: #f8f9fa;
              padding: 1.5rem;
              border-radius: 8px;
              border-left: 4px solid #9b59b6;
            "
          >
            <h3
              style="
                color: #9b59b6;
                margin-top: 0;
                display: flex;
                align-items: center;
              "
            >
              <span style="font-size: 1.5rem; margin-right: 0.5rem">🔍</span
              >視覺化範例
            </h3>
            <div
              style="
                display: flex;
                flex-direction: column;
                gap: 1rem;
                margin-top: 1rem;
              "
            >
              <div
                style="
                  background-color: white;
                  padding: 1rem;
                  border-radius: 6px;
                  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                "
              >
                <h4
                  style="
                    color: #9b59b6;
                    margin: 0 0 0.5rem 0;
                    display: flex;
                    align-items: center;
                  "
                >
                  <span style="font-size: 1.2rem; margin-right: 0.5rem">📊</span
                  >Input IDs vs Target IDs
                </h4>
                <div
                  style="
                    display: flex;
                    flex-direction: column;
                    gap: 0.5rem;
                    font-family: monospace;
                    font-size: 1rem;
                  "
                >
                  <div
                    style="
                      background-color: #f1f1f1;
                      padding: 0.8rem;
                      border-radius: 4px;
                    "
                  >
                    <strong>Input IDs:</strong> [0, 1, 2, 3, 4, 50256, 50256,
                    50256]
                  </div>
                  <div
                    style="
                      background-color: #f1f1f1;
                      padding: 0.8rem;
                      border-radius: 4px;
                    "
                  >
                    <strong>Target IDs:</strong> [1, 2, 3, 4, 50256, -100, -100,
                    -100]
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Slide 15: Dataset Class Implementation -->
    <div class="slide">
      <div class="slide-content">
        <h2><span class="emoji">📚</span>Dataset 類別實作</h2>

        <div
          style="
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            margin-top: 1.5rem;
          "
        >
          <div
            style="
              background-color: #f8f9fa;
              padding: 1.5rem;
              border-radius: 8px;
              border-left: 4px solid #3498db;
            "
          >
            <h3
              style="
                color: #3498db;
                margin-top: 0;
                display: flex;
                align-items: center;
              "
            >
              <span style="font-size: 1.5rem; margin-right: 0.5rem">📋</span
              >InstructionDataset 類別
            </h3>
            <p style="font-size: 1.1rem; line-height: 1.5">
              這個類別負責將指令數據轉換為模型可用的格式，包括格式化輸入文本和對其進行編碼。
            </p>
            <div
              style="
                background-color: white;
                padding: 1rem;
                border-radius: 6px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                margin-top: 1rem;
              "
            >
              <div style="display: flex; align-items: flex-start; gap: 0.5rem">
                <span style="font-size: 1.2rem; color: #3498db">📌</span>
                <pre
                  style="
                    margin: 0;
                    background-color: #282c34;
                    border-radius: 6px;
                    padding: 0.8rem;
                  "
                ><code class="language-python">import torch
from torch.utils.data import Dataset

class InstructionDataset(Dataset):
    def __init__(self, data, tokenizer):
        self.data = data
        self.tokenizer = tokenizer
        self.encoded_texts = []
        for entry in data:
            instruction_plus_input = format_input(entry)
            response = f"\n\n### Response:\n{entry['output']}"
            full_text = instruction_plus_input + response
            self.encoded_texts.append(tokenizer.encode(full_text))

    def __getitem__(self, index):
        return self.encoded_texts[index]

    def __len__(self):
        return len(self.data)</code></pre>
              </div>
            </div>
          </div>

          <div
            style="
              background-color: #f8f9fa;
              padding: 1.5rem;
              border-radius: 8px;
              border-left: 4px solid #2ecc71;
            "
          >
            <h3
              style="
                color: #2ecc71;
                margin-top: 0;
                display: flex;
                align-items: center;
              "
            >
              <span style="font-size: 1.5rem; margin-right: 0.5rem">🔍</span
              >類別功能解析
            </h3>
            <div
              style="
                display: flex;
                flex-direction: column;
                gap: 1rem;
                margin-top: 1rem;
              "
            >
              <div
                style="
                  background-color: white;
                  padding: 1rem;
                  border-radius: 6px;
                  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                "
              >
                <h4
                  style="
                    color: #2ecc71;
                    margin: 0 0 0.5rem 0;
                    display: flex;
                    align-items: center;
                  "
                >
                  <span style="font-size: 1.2rem; margin-right: 0.5rem">1️⃣</span
                  >初始化方法
                </h4>
                <p style="margin: 0; font-size: 1.1rem">
                  在初始化時，遍歷所有數據條目，將每個條目格式化為指令加輸入的形式，然後添加回應部分，最後使用tokenizer對完整文本進行編碼。
                </p>
              </div>

              <div
                style="
                  background-color: white;
                  padding: 1rem;
                  border-radius: 6px;
                  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                "
              >
                <h4
                  style="
                    color: #2ecc71;
                    margin: 0 0 0.5rem 0;
                    display: flex;
                    align-items: center;
                  "
                >
                  <span style="font-size: 1.2rem; margin-right: 0.5rem">2️⃣</span
                  >獲取數據方法
                </h4>
                <p style="margin: 0; font-size: 1.1rem">
                  <code>__getitem__</code> 方法返回指定索引的編碼文本，<code
                    >__len__</code
                  >
                  方法返回數據集的總長度，這兩個方法是PyTorch
                  Dataset接口的必要實現。
                </p>
              </div>
            </div>
          </div>

          <div
            style="
              background-color: #f8f9fa;
              padding: 1.5rem;
              border-radius: 8px;
              border-left: 4px solid #e74c3c;
            "
          >
            <h3
              style="
                color: #e74c3c;
                margin-top: 0;
                display: flex;
                align-items: center;
              "
            >
              <span style="font-size: 1.5rem; margin-right: 0.5rem">📊</span
              >數據格式示例
            </h3>
            <div
              style="
                display: flex;
                flex-direction: column;
                gap: 1rem;
                margin-top: 1rem;
              "
            >
              <div
                style="
                  background-color: white;
                  padding: 1rem;
                  border-radius: 6px;
                  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                "
              >
                <h4
                  style="
                    color: #e74c3c;
                    margin: 0 0 0.5rem 0;
                    display: flex;
                    align-items: center;
                  "
                >
                  <span style="font-size: 1.2rem; margin-right: 0.5rem">📝</span
                  >原始數據
                </h4>
                <div
                  style="
                    background-color: #f1f1f1;
                    padding: 0.8rem;
                    border-radius: 4px;
                    font-family: monospace;
                    font-size: 1rem;
                  "
                >
                  <pre style="margin: 0"><code class="language-json">{
  "instruction": "Convert the active sentence to passive",
  "input": "The chef cooks the meal every day.",
  "output": "The meal is cooked by the chef every day."
}</code></pre>
                </div>
              </div>

              <div
                style="
                  background-color: white;
                  padding: 1rem;
                  border-radius: 6px;
                  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                "
              >
                <h4
                  style="
                    color: #e74c3c;
                    margin: 0 0 0.5rem 0;
                    display: flex;
                    align-items: center;
                  "
                >
                  <span style="font-size: 1.2rem; margin-right: 0.5rem">🔄</span
                  >格式化後
                </h4>
                <div
                  style="
                    background-color: #f1f1f1;
                    padding: 0.8rem;
                    border-radius: 4px;
                    font-family: monospace;
                    font-size: 1rem;
                  "
                >
                  <pre
                    style="margin: 0"
                  ><code class="language-text">Convert the active sentence to passive: 'The chef cooks the meal every day.'

### Response:
The meal is cooked by the chef every day.</code></pre>
                </div>
              </div>

              <div
                style="
                  background-color: white;
                  padding: 1rem;
                  border-radius: 6px;
                  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                "
              >
                <h4
                  style="
                    color: #e74c3c;
                    margin: 0 0 0.5rem 0;
                    display: flex;
                    align-items: center;
                  "
                >
                  <span style="font-size: 1.2rem; margin-right: 0.5rem">🔢</span
                  >編碼後
                </h4>
                <div
                  style="
                    background-color: #f1f1f1;
                    padding: 0.8rem;
                    border-radius: 4px;
                    font-family: monospace;
                    font-size: 1rem;
                  "
                >
                  <pre
                    style="margin: 0"
                  ><code class="language-python">[token_ids...]  # 實際的token ID序列</code></pre>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Slide 16: Collate Function Introduction -->
    <div class="slide">
      <div class="slide-content">
        <h2><span class="emoji">🔄</span>Collate Function 介紹</h2>

        <div
          style="
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            margin-top: 1.5rem;
          "
        >
          <div
            style="
              background-color: #f8f9fa;
              padding: 1.5rem;
              border-radius: 8px;
              border-left: 4px solid #3498db;
            "
          >
            <h3
              style="
                color: #3498db;
                margin-top: 0;
                display: flex;
                align-items: center;
              "
            >
              <span style="font-size: 1.5rem; margin-right: 0.5rem">📋</span
              >Collate Function 的作用
            </h3>
            <p style="font-size: 1.1rem; line-height: 1.5">
              Collate Function
              負責將多個數據樣本組合成一個批次（batch），處理不同長度的序列，並準備輸入和目標張量。
            </p>
          </div>

          <div
            style="
              background-color: #f8f9fa;
              padding: 1.5rem;
              border-radius: 8px;
              border-left: 4px solid #2ecc71;
            "
          >
            <h3
              style="
                color: #2ecc71;
                margin-top: 0;
                display: flex;
                align-items: center;
              "
            >
              <span style="font-size: 1.5rem; margin-right: 0.5rem">🔄</span
              >初版 Collate Function
            </h3>
            <div
              style="
                background-color: white;
                padding: 1rem;
                border-radius: 6px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                margin-top: 1rem;
              "
            >
              <div style="display: flex; align-items: flex-start; gap: 0.5rem">
                <span style="font-size: 1.2rem; color: #2ecc71">📌</span>
                <pre
                  style="
                    margin: 0;
                    background-color: #282c34;
                    border-radius: 6px;
                    padding: 0.8rem;
                  "
                ><code class="language-python">def custom_collate_draft_1(batch, pad_token_id=50256, device="cpu"):
    batch_max_length = max(len(item)+1 for item in batch)
    inputs_list = []

    for item in batch:
        new_item = item.copy()
        new_item += [pad_token_id]
        padded = new_item + [pad_token_id] * (batch_max_length - len(new_item))
        inputs = torch.tensor(padded[:-1])
        inputs_list.append(inputs)

    inputs_tensor = torch.stack(inputs_list).to(device)
    return inputs_tensor</code></pre>
              </div>
            </div>
            <p style="font-size: 1.1rem; line-height: 1.5; margin-top: 1rem">
              初版 Collate Function
              只處理了輸入序列的填充，沒有處理目標序列和忽略索引。
            </p>
          </div>

          <div
            style="
              background-color: #f8f9fa;
              padding: 1.5rem;
              border-radius: 8px;
              border-left: 4px solid #e74c3c;
            "
          >
            <h3
              style="
                color: #e74c3c;
                margin-top: 0;
                display: flex;
                align-items: center;
              "
            >
              <span style="font-size: 1.5rem; margin-right: 0.5rem">✅</span
              >最終 Collate Function
            </h3>
            <div
              style="
                background-color: white;
                padding: 1rem;
                border-radius: 6px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                margin-top: 1rem;
              "
            >
              <div style="display: flex; align-items: flex-start; gap: 0.5rem">
                <span style="font-size: 1.2rem; color: #e74c3c">📌</span>
                <pre
                  style="
                    margin: 0;
                    background-color: #282c34;
                    border-radius: 6px;
                    padding: 0.8rem;
                  "
                ><code class="language-python">def custom_collate_fn(
    batch,
    pad_token_id=50256,
    ignore_index=-100,
    allowed_max_length=None,
    device="cpu"
):
    batch_max_length = max(len(item)+1 for item in batch)
    inputs_list, targets_list = [], []

    for item in batch:
        new_item = item.copy()
        new_item += [pad_token_id]  # 加一個 padding 作為末端 token

        padded = new_item + [pad_token_id] * (batch_max_length - len(new_item))
        inputs = torch.tensor(padded[:-1])
        targets = torch.tensor(padded[1:])  # 右移一位作為 target

        # 將所有 padding token 標記為 -100（ignore loss），但保留第一個
        mask = targets == pad_token_id
        indices = torch.nonzero(mask).squeeze()
        if indices.numel() > 1:
            targets[indices[1:]] = ignore_index

        if allowed_max_length is not None:
            inputs = inputs[:allowed_max_length]
            targets = targets[:allowed_max_length]

        inputs_list.append(inputs)
        targets_list.append(targets)

    inputs_tensor = torch.stack(inputs_list).to(device)
    targets_tensor = torch.stack(targets_list).to(device)
    return inputs_tensor, targets_tensor</code></pre>
              </div>
            </div>
          </div>

          <div
            style="
              background-color: #f8f9fa;
              padding: 1.5rem;
              border-radius: 8px;
              border-left: 4px solid #9b59b6;
            "
          >
            <h3
              style="
                color: #9b59b6;
                margin-top: 0;
                display: flex;
                align-items: center;
              "
            >
              <span style="font-size: 1.5rem; margin-right: 0.5rem">🔍</span
              >關鍵功能解析
            </h3>
            <div
              style="
                display: flex;
                flex-direction: column;
                gap: 1rem;
                margin-top: 1rem;
              "
            >
              <div
                style="
                  background-color: white;
                  padding: 1rem;
                  border-radius: 6px;
                  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                "
              >
                <h4
                  style="
                    color: #9b59b6;
                    margin: 0 0 0.5rem 0;
                    display: flex;
                    align-items: center;
                  "
                >
                  <span style="font-size: 1.2rem; margin-right: 0.5rem">1️⃣</span
                  >填充處理
                </h4>
                <p style="margin: 0; font-size: 1.1rem">
                  將不同長度的序列填充到批次中最長序列的長度，使用
                  <code>pad_token_id</code>（默認為 50256）進行填充。
                </p>
              </div>

              <div
                style="
                  background-color: white;
                  padding: 1rem;
                  border-radius: 6px;
                  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                "
              >
                <h4
                  style="
                    color: #9b59b6;
                    margin: 0 0 0.5rem 0;
                    display: flex;
                    align-items: center;
                  "
                >
                  <span style="font-size: 1.2rem; margin-right: 0.5rem">2️⃣</span
                  >目標序列生成
                </h4>
                <p style="margin: 0; font-size: 1.1rem">
                  通過將輸入序列右移一位來生成目標序列，這樣模型可以學習預測下一個
                  token。
                </p>
              </div>

              <div
                style="
                  background-color: white;
                  padding: 1rem;
                  border-radius: 6px;
                  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                "
              >
                <h4
                  style="
                    color: #9b59b6;
                    margin: 0 0 0.5rem 0;
                    display: flex;
                    align-items: center;
                  "
                >
                  <span style="font-size: 1.2rem; margin-right: 0.5rem">3️⃣</span
                  >忽略索引處理
                </h4>
                <p style="margin: 0; font-size: 1.1rem">
                  將目標序列中的 padding tokens 標記為
                  <code>ignore_index</code>（默認為 -100），使它們不參與 loss
                  計算，但保留第一個 padding token。
                </p>
              </div>

              <div
                style="
                  background-color: white;
                  padding: 1rem;
                  border-radius: 6px;
                  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                "
              >
                <h4
                  style="
                    color: #9b59b6;
                    margin: 0 0 0.5rem 0;
                    display: flex;
                    align-items: center;
                  "
                >
                  <span style="font-size: 1.2rem; margin-right: 0.5rem">4️⃣</span
                  >長度限制
                </h4>
                <p style="margin: 0; font-size: 1.1rem">
                  如果提供了
                  <code>allowed_max_length</code>
                  參數，則將輸入和目標序列截斷到指定長度，以控制序列的最大長度。
                </p>
              </div>
            </div>
          </div>

          <div
            style="
              background-color: #f8f9fa;
              padding: 1.5rem;
              border-radius: 8px;
              border-left: 4px solid #f39c12;
            "
          >
            <h3
              style="
                color: #f39c12;
                margin-top: 0;
                display: flex;
                align-items: center;
              "
            >
              <span style="font-size: 1.5rem; margin-right: 0.5rem">📊</span
              >結果範例
            </h3>
            <div
              style="
                display: flex;
                flex-direction: column;
                gap: 1rem;
                margin-top: 1rem;
              "
            >
              <div
                style="
                  background-color: white;
                  padding: 1rem;
                  border-radius: 6px;
                  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                "
              >
                <h4
                  style="
                    color: #f39c12;
                    margin: 0 0 0.5rem 0;
                    display: flex;
                    align-items: center;
                  "
                >
                  <span style="font-size: 1.2rem; margin-right: 0.5rem">🔢</span
                  >輸入和目標張量
                </h4>
                <div
                  style="
                    background-color: #f1f1f1;
                    padding: 0.8rem;
                    border-radius: 4px;
                    font-family: monospace;
                    font-size: 1rem;
                  "
                >
                  <pre style="margin: 0"><code class="language-python">inputs:
[[ 0,  1,  2,  3,  4],
 [ 5,  6, 50256, 50256, 50256],
 [ 7,  8,  9, 50256, 50256]]

targets:
[[ 1,  2,  3,  4, 50256],
 [ 6, 50256, -100, -100, -100],
 [ 8,  9, 50256, -100, -100]]</code></pre>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Slide 17: Loss Calculation Logic Analysis -->
    <div class="slide">
      <div class="slide-content">
        <h2><span class="emoji">🧪</span>Loss 計算邏輯解析</h2>

        <div
          style="
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            margin-top: 1.5rem;
          "
        >
          <div
            style="
              background-color: #f8f9fa;
              padding: 1.5rem;
              border-radius: 8px;
              border-left: 4px solid #3498db;
            "
          >
            <h3
              style="
                color: #3498db;
                margin-top: 0;
                display: flex;
                align-items: center;
              "
            >
              <span style="font-size: 1.5rem; margin-right: 0.5rem">📊</span
              >Cross Entropy Loss 計算
            </h3>
            <p style="font-size: 1.1rem; line-height: 1.5">
              Cross Entropy Loss
              是語言模型訓練中最常用的損失函數，用於衡量模型預測與實際目標之間的差異。通過
              ignore_index 參數，我們可以指定某些 token 不參與 loss 計算。
            </p>
          </div>

          <div
            style="
              background-color: #f8f9fa;
              padding: 1.5rem;
              border-radius: 8px;
              border-left: 4px solid #2ecc71;
            "
          >
            <h3
              style="
                color: #2ecc71;
                margin-top: 0;
                display: flex;
                align-items: center;
              "
            >
              <span style="font-size: 1.5rem; margin-right: 0.5rem">💻</span
              >Loss 計算示例
            </h3>
            <div
              style="
                background-color: white;
                padding: 1rem;
                border-radius: 6px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                margin-top: 1rem;
              "
            >
              <div style="display: flex; align-items: flex-start; gap: 0.5rem">
                <span style="font-size: 1.2rem; color: #2ecc71">📌</span>
                <pre
                  style="
                    margin: 0;
                    background-color: #282c34;
                    border-radius: 6px;
                    padding: 0.8rem;
                  "
                ><code class="language-python">import torch
  
  # 模擬 logits (預測值)
  logits_1 = torch.tensor([
      [-1.0, 1.0],  # 第 1 個 token 預測值
      [-0.5, 1.5]   # 第 2 個 token 預測值
  ])
  targets_1 = torch.tensor([0, 1])
  loss_1 = torch.nn.functional.cross_entropy(logits_1, targets_1)
  print(loss_1)  # tensor(1.1269)
  
  # 加入第 3 個 token
  logits_2 = torch.tensor([
      [-1.0, 1.0],
      [-0.5, 1.5],
      [-0.5, 1.5]
  ])
  targets_2 = torch.tensor([0, 1, 1])
  loss_2 = torch.nn.functional.cross_entropy(logits_2, targets_2)
  print(loss_2)  # tensor(0.7936)
  
  # 加入 masking（-100）
  targets_3 = torch.tensor([0, 1, -100])
  loss_3 = torch.nn.functional.cross_entropy(logits_2, targets_3, ignore_index=-100)
  print(loss_3)  # tensor(1.1269)，忽略了第三個 token 的 loss</code></pre>
              </div>
            </div>
          </div>

          <div
            style="
              background-color: #f8f9fa;
              padding: 1.5rem;
              border-radius: 8px;
              border-left: 4px solid #e74c3c;
            "
          >
            <h3
              style="
                color: #e74c3c;
                margin-top: 0;
                display: flex;
                align-items: center;
              "
            >
              <span style="font-size: 1.5rem; margin-right: 0.5rem">🔍</span
              >Loss 計算邏輯解析
            </h3>
            <div
              style="
                display: flex;
                flex-direction: column;
                gap: 1rem;
                margin-top: 1rem;
              "
            >
              <div
                style="
                  background-color: white;
                  padding: 1rem;
                  border-radius: 6px;
                  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                "
              >
                <h4
                  style="
                    color: #e74c3c;
                    margin: 0 0 0.5rem 0;
                    display: flex;
                    align-items: center;
                  "
                >
                  <span style="font-size: 1.2rem; margin-right: 0.5rem">1️⃣</span
                  >基本計算
                </h4>
                <p style="margin: 0; font-size: 1.1rem">
                  對於每個位置，計算模型預測的 logits 與目標 token
                  之間的交叉熵損失，然後取平均值。
                </p>
              </div>

              <div
                style="
                  background-color: white;
                  padding: 1rem;
                  border-radius: 6px;
                  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                "
              >
                <h4
                  style="
                    color: #e74c3c;
                    margin: 0 0 0.5rem 0;
                    display: flex;
                    align-items: center;
                  "
                >
                  <span style="font-size: 1.2rem; margin-right: 0.5rem">2️⃣</span
                  >忽略索引的作用
                </h4>
                <p style="margin: 0; font-size: 1.1rem">
                  當使用 <code>ignore_index=-100</code> 時，所有標記為 -100
                  的目標 token 不參與 loss
                  計算，這使得我們可以選擇性地忽略某些位置的損失。
                </p>
              </div>

              <div
                style="
                  background-color: white;
                  padding: 1rem;
                  border-radius: 6px;
                  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                "
              >
                <h4
                  style="
                    color: #e74c3c;
                    margin: 0 0 0.5rem 0;
                    display: flex;
                    align-items: center;
                  "
                >
                  <span style="font-size: 1.2rem; margin-right: 0.5rem">3️⃣</span
                  >示例分析
                </h4>
                <p style="margin: 0; font-size: 1.1rem">
                  在上面的示例中，<code>loss_1</code> 和
                  <code>loss_3</code> 的值相同（1.1269），這是因為
                  <code>loss_3</code> 中的第三個 token 被標記為
                  -100，不參與計算，所以只計算了前兩個 token 的損失，與
                  <code>loss_1</code> 相同。
                </p>
              </div>
            </div>
          </div>

          <div
            style="
              background-color: #f8f9fa;
              padding: 1.5rem;
              border-radius: 8px;
              border-left: 4px solid #9b59b6;
            "
          >
            <h3
              style="
                color: #9b59b6;
                margin-top: 0;
                display: flex;
                align-items: center;
              "
            >
              <span style="font-size: 1.5rem; margin-right: 0.5rem">📈</span
              >Loss 計算的應用
            </h3>
            <div
              style="
                display: flex;
                flex-direction: column;
                gap: 1rem;
                margin-top: 1rem;
              "
            >
              <div
                style="
                  background-color: white;
                  padding: 1rem;
                  border-radius: 6px;
                  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                "
              >
                <h4
                  style="
                    color: #9b59b6;
                    margin: 0 0 0.5rem 0;
                    display: flex;
                    align-items: center;
                  "
                >
                  <span style="font-size: 1.2rem; margin-right: 0.5rem">🎯</span
                  >在指令微調中的應用
                </h4>
                <p style="margin: 0; font-size: 1.1rem">
                  在指令微調中，我們可以使用 ignore_index 來選擇性地忽略
                  instruction 和 input 部分的損失，只讓模型學習生成 response
                  部分。這樣可以避免模型背誦
                  prompt，專注於學習如何根據指令生成回應。
                </p>
              </div>

              <div
                style="
                  background-color: white;
                  padding: 1rem;
                  border-radius: 6px;
                  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                "
              >
                <h4
                  style="
                    color: #9b59b6;
                    margin: 0 0 0.5rem 0;
                    display: flex;
                    align-items: center;
                  "
                >
                  <span style="font-size: 1.2rem; margin-right: 0.5rem">🔄</span
                  >與 padding 處理的結合
                </h4>
                <p style="margin: 0; font-size: 1.1rem">
                  在批處理中，我們通常會將不同長度的序列填充到相同長度，並將填充部分的目標
                  token 標記為 -100，使它們不參與 loss
                  計算。這樣可以確保模型只學習預測實際的內容，而不是填充 token。
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Slide 18: Instruction Masking -->
    <div class="slide">
      <div class="slide-content">
        <h2><span class="emoji">🎭</span>Instruction Masking</h2>

        <div
          style="
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            margin-top: 1.5rem;
          "
        >
          <div
            style="
              background-color: #f8f9fa;
              padding: 1.5rem;
              border-radius: 8px;
              border-left: 4px solid #3498db;
            "
          >
            <h3
              style="
                color: #3498db;
                margin-top: 0;
                display: flex;
                align-items: center;
              "
            >
              <span style="font-size: 1.5rem; margin-right: 0.5rem">🔍</span
              >遮罩的概念
            </h3>
            <p style="font-size: 1.1rem; line-height: 1.5">
              除了 padding token，也可選擇性地 mask 掉 instruction/input 的
              tokens，避免模型背誦 prompt。將該區段 token ID 設為 -100，讓 loss
              只對 response 區段負責。
            </p>
          </div>

          <div
            style="
              background-color: #f8f9fa;
              padding: 1.5rem;
              border-radius: 8px;
              border-left: 4px solid #2ecc71;
            "
          >
            <h3
              style="
                color: #2ecc71;
                margin-top: 0;
                display: flex;
                align-items: center;
              "
            >
              <span style="font-size: 1.5rem; margin-right: 0.5rem">⚠️</span
              >最新研究發現
            </h3>
            <div
              style="
                background-color: white;
                padding: 1rem;
                border-radius: 6px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                margin-top: 1rem;
              "
            >
              <p style="margin: 0; font-size: 1.1rem">
                2024 年的論文《Instruction Tuning With Loss Over
                Instructions》指出：<strong
                  >不遮蔽 instruction 能帶來更好的效果</strong
                >。本書讓你視情況決定是否採用遮罩策略。
              </p>
            </div>
          </div>

          <div
            style="
              background-color: #f8f9fa;
              padding: 1.5rem;
              border-radius: 8px;
              border-left: 4px solid #e74c3c;
            "
          >
            <h3
              style="
                color: #e74c3c;
                margin-top: 0;
                display: flex;
                align-items: center;
              "
            >
              <span style="font-size: 1.5rem; margin-right: 0.5rem">💻</span
              >整合遮罩的 Collate Function
            </h3>
            <div
              style="
                background-color: white;
                padding: 1rem;
                border-radius: 6px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                margin-top: 1rem;
              "
            >
              <div style="display: flex; align-items: flex-start; gap: 0.5rem">
                <span style="font-size: 1.2rem; color: #e74c3c">📌</span>
                <pre
                  style="
                    margin: 0;
                    background-color: #282c34;
                    border-radius: 6px;
                    padding: 0.8rem;
                  "
                ><code class="language-python">def custom_collate_fn(
    batch,
    pad_token_id=50256,
    ignore_index=-100,
    allowed_max_length=None,
    device="cpu"
):
    batch_max_length = max(len(item) + 1 for item in batch)
    inputs_list, targets_list = [], []

    for item in batch:
        new_item = item.copy()
        new_item += [pad_token_id]  # append one for target shift
        padded = new_item + [pad_token_id] * (batch_max_length - len(new_item))

        inputs = torch.tensor(padded[:-1])
        targets = torch.tensor(padded[1:])

        # 遮蔽 padding token（除了第一個）
        mask = targets == pad_token_id
        indices = torch.nonzero(mask).squeeze()
        if indices.numel() > 1:
            targets[indices[1:]] = ignore_index

        # 遮蔽 instruction 區段（optional，見 Figure 7.13）
        # 可自行設計額外 masking 機制，找出 instruction 對應的位置後設成 -100

        if allowed_max_length is not None:
            inputs = inputs[:allowed_max_length]
            targets = targets[:allowed_max_length]

        inputs_list.append(inputs)
        targets_list.append(targets)

    return (
        torch.stack(inputs_list).to(device),
        torch.stack(targets_list).to(device)
    )</code></pre>
              </div>
            </div>
          </div>

          <div
            style="
              background-color: #f8f9fa;
              padding: 1.5rem;
              border-radius: 8px;
              border-left: 4px solid #9b59b6;
            "
          >
            <h3
              style="
                color: #9b59b6;
                margin-top: 0;
                display: flex;
                align-items: center;
              "
            >
              <span style="font-size: 1.5rem; margin-right: 0.5rem">📊</span
              >遮罩範例
            </h3>
            <div
              style="
                display: flex;
                flex-direction: column;
                gap: 1rem;
                margin-top: 1rem;
              "
            >
              <img src="images/fig7_13.png" alt="Figure 7.13" />
              <div
                style="
                  background-color: white;
                  padding: 1rem;
                  border-radius: 6px;
                  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                "
              >
                <table style="width: 100%; border-collapse: collapse">
                  <thead>
                    <tr style="background-color: #9b59b6; color: white">
                      <th
                        style="
                          padding: 0.8rem;
                          text-align: left;
                          border-radius: 4px 0 0 0;
                        "
                      >
                        區段
                      </th>
                      <th
                        style="
                          padding: 0.8rem;
                          text-align: left;
                          border-radius: 0 4px 0 0;
                        "
                      >
                        是否參與 loss
                      </th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr style="background-color: #f8f9fa">
                      <td
                        style="padding: 0.8rem; border-bottom: 1px solid #ddd"
                      >
                        Instruction
                      </td>
                      <td
                        style="padding: 0.8rem; border-bottom: 1px solid #ddd"
                      >
                        ❌ -100
                      </td>
                    </tr>
                    <tr style="background-color: white">
                      <td
                        style="padding: 0.8rem; border-bottom: 1px solid #ddd"
                      >
                        Input
                      </td>
                      <td
                        style="padding: 0.8rem; border-bottom: 1px solid #ddd"
                      >
                        ❌ -100
                      </td>
                    </tr>
                    <tr style="background-color: #f8f9fa">
                      <td style="padding: 0.8rem">Response</td>
                      <td style="padding: 0.8rem">✅ 正常計算</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <div
            style="
              background-color: #f8f9fa;
              padding: 1.5rem;
              border-radius: 8px;
              border-left: 4px solid #f39c12;
            "
          >
            <h3
              style="
                color: #f39c12;
                margin-top: 0;
                display: flex;
                align-items: center;
              "
            >
              <span style="font-size: 1.5rem; margin-right: 0.5rem">✅</span
              >建議做法
            </h3>
            <div
              style="
                display: flex;
                flex-direction: column;
                gap: 1rem;
                margin-top: 1rem;
              "
            >
              <div
                style="
                  background-color: white;
                  padding: 1rem;
                  border-radius: 6px;
                  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                "
              >
                <table style="width: 100%; border-collapse: collapse">
                  <thead>
                    <tr style="background-color: #f39c12; color: white">
                      <th
                        style="
                          padding: 0.8rem;
                          text-align: left;
                          border-radius: 4px 0 0 0;
                        "
                      >
                        場景
                      </th>
                      <th
                        style="
                          padding: 0.8rem;
                          text-align: left;
                          border-radius: 0 4px 0 0;
                        "
                      >
                        建議做法
                      </th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr style="background-color: #f8f9fa">
                      <td
                        style="padding: 0.8rem; border-bottom: 1px solid #ddd"
                      >
                        預設情況 / 小模型 / 資料少
                      </td>
                      <td
                        style="padding: 0.8rem; border-bottom: 1px solid #ddd"
                      >
                        不遮蔽 instruction
                      </td>
                    </tr>
                    <tr style="background-color: white">
                      <td style="padding: 0.8rem">
                        避免 overfitting / response 精準訓練
                      </td>
                      <td style="padding: 0.8rem">採用 masking</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Slide 19: Creating Data Loaders for an Instruction Dataset-->
    <div class="slide">
      <div class="slide-content">
        <h2><span class="emoji">🔌</span>建立 DataLoader 以供 LLM 微調使用</h2>

        <div
          style="
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            margin-top: 1.5rem;
          "
        >
          <div
            style="
              background-color: #f8f9fa;
              padding: 1.5rem;
              border-radius: 8px;
              border-left: 4px solid #3498db;
            "
          >
            <h3
              style="
                color: #3498db;
                margin-top: 0;
                display: flex;
                align-items: center;
              "
            >
              <span style="font-size: 1.5rem; margin-right: 0.5rem">🎯</span
              >目標
            </h3>
            <p style="font-size: 1.1rem; line-height: 1.5">
              整合自訂的 <code>InstructionDataset</code> 類別（用來格式化和編碼
              instruction）和自訂的 <code>custom_collate_fn</code>（處理
              padding、target shifting、masking）來建立訓練、驗證、測試的
              PyTorch <code>DataLoader</code>。
            </p>
          </div>

          <div
            style="
              background-color: #f8f9fa;
              padding: 1.5rem;
              border-radius: 8px;
              border-left: 4px solid #2ecc71;
            "
          >
            <h3
              style="
                color: #2ecc71;
                margin-top: 0;
                display: flex;
                align-items: center;
              "
            >
              <span style="font-size: 1.5rem; margin-right: 0.5rem">💻</span
              >裝置設定
            </h3>
            <div
              style="
                background-color: white;
                padding: 1rem;
                border-radius: 6px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                margin-top: 1rem;
              "
            >
              <div style="display: flex; align-items: flex-start; gap: 0.5rem">
                <span style="font-size: 1.2rem; color: #2ecc71">📌</span>
                <pre
                  style="
                    margin: 0;
                    background-color: #282c34;
                    border-radius: 6px;
                    padding: 0.8rem;
                  "
                ><code class="language-python">device = torch.device("cuda" if torch.cuda.is_available() else "cpu")
print("Device:", device)

# 若使用 Apple M1/M2 晶片，可選擇：
# device = torch.device("mps")</code></pre>
              </div>
              <p style="margin: 1rem 0 0 0; font-size: 1.1rem">
                為了避免在訓練 loop 阻塞 GPU 計算，可在
                <code>collate_fn</code> 裡設定資料搬移至 GPU（或 CPU）。
              </p>
            </div>
          </div>

          <div
            style="
              background-color: #f8f9fa;
              padding: 1.5rem;
              border-radius: 8px;
              border-left: 4px solid #e74c3c;
            "
          >
            <h3
              style="
                color: #e74c3c;
                margin-top: 0;
                display: flex;
                align-items: center;
              "
            >
              <span style="font-size: 1.5rem; margin-right: 0.5rem">🛠</span>使用
              functools.partial 製作 collate function
            </h3>
            <div
              style="
                background-color: white;
                padding: 1rem;
                border-radius: 6px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                margin-top: 1rem;
              "
            >
              <div style="display: flex; align-items: flex-start; gap: 0.5rem">
                <span style="font-size: 1.2rem; color: #e74c3c">📌</span>
                <pre
                  style="
                    margin: 0;
                    background-color: #282c34;
                    border-radius: 6px;
                    padding: 0.8rem;
                  "
                ><code class="language-python">from functools import partial

customized_collate_fn = partial(
    custom_collate_fn,           # 之前定義的 collate 函數
    device=device,
    allowed_max_length=1024      # 限制序列長度
)</code></pre>
              </div>
              <p style="margin: 1rem 0 0 0; font-size: 1.1rem">
                設定好裝置與最大長度後，使用
                <code>partial()</code> 自動傳入這些預設參數。
              </p>
            </div>
          </div>

          <div
            style="
              background-color: #f8f9fa;
              padding: 1.5rem;
              border-radius: 8px;
              border-left: 4px solid #9b59b6;
            "
          >
            <h3
              style="
                color: #9b59b6;
                margin-top: 0;
                display: flex;
                align-items: center;
              "
            >
              <span style="font-size: 1.5rem; margin-right: 0.5rem">🧱</span
              >初始化 DataLoader
            </h3>
            <div
              style="
                background-color: white;
                padding: 1rem;
                border-radius: 6px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                margin-top: 1rem;
              "
            >
              <div style="display: flex; align-items: flex-start; gap: 0.5rem">
                <span style="font-size: 1.2rem; color: #9b59b6">📌</span>
                <pre
                  style="
                    margin: 0;
                    background-color: #282c34;
                    border-radius: 6px;
                    padding: 0.8rem;
                  "
                ><code class="language-python">from torch.utils.data import DataLoader

num_workers = 0          # 可依作業系統調高
batch_size = 8

torch.manual_seed(123)   # 設定隨機種子確保可重現性

# 假設已經有 train_data, val_data, test_data
train_dataset = InstructionDataset(train_data, tokenizer)
val_dataset   = InstructionDataset(val_data, tokenizer)
test_dataset  = InstructionDataset(test_data, tokenizer)

train_loader = DataLoader(
    train_dataset,
    batch_size=batch_size,
    collate_fn=customized_collate_fn,
    shuffle=True,
    drop_last=True,
    num_workers=num_workers
)

val_loader = DataLoader(
    val_dataset,
    batch_size=batch_size,
    collate_fn=customized_collate_fn,
    shuffle=False,
    drop_last=False,
    num_workers=num_workers
)

test_loader = DataLoader(
    test_dataset,
    batch_size=batch_size,
    collate_fn=customized_collate_fn,
    shuffle=False,
    drop_last=False,
    num_workers=num_workers
)</code></pre>
              </div>
            </div>
          </div>

          <div
            style="
              background-color: #f8f9fa;
              padding: 1.5rem;
              border-radius: 8px;
              border-left: 4px solid #f39c12;
            "
          >
            <h3
              style="
                color: #f39c12;
                margin-top: 0;
                display: flex;
                align-items: center;
              "
            >
              <span style="font-size: 1.5rem; margin-right: 0.5rem">🔍</span
              >輸出檢查結果
            </h3>
            <div
              style="
                display: flex;
                flex-direction: column;
                gap: 1rem;
                margin-top: 1rem;
              "
            >
              <div
                style="
                  background-color: white;
                  padding: 1rem;
                  border-radius: 6px;
                  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                "
              >
                <h4
                  style="
                    color: #f39c12;
                    margin: 0 0 0.5rem 0;
                    display: flex;
                    align-items: center;
                  "
                >
                  <span style="font-size: 1.2rem; margin-right: 0.5rem">📊</span
                  >檢查 input 與 target 張量的 shape
                </h4>
                <div
                  style="display: flex; align-items: flex-start; gap: 0.5rem"
                >
                  <span style="font-size: 1.2rem; color: #f39c12">📌</span>
                  <pre
                    style="
                      margin: 0;
                      background-color: #282c34;
                      border-radius: 6px;
                      padding: 0.8rem;
                    "
                  ><code class="language-python">print("Train loader:")
for inputs, targets in train_loader:
    print(inputs.shape, targets.shape)</code></pre>
                </div>
              </div>

              <div
                style="
                  background-color: white;
                  padding: 1rem;
                  border-radius: 6px;
                  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                "
              >
                <h4
                  style="
                    color: #f39c12;
                    margin: 0 0 0.5rem 0;
                    display: flex;
                    align-items: center;
                  "
                >
                  <span style="font-size: 1.2rem; margin-right: 0.5rem">📝</span
                  >輸出範例
                </h4>
                <pre
                  style="
                    margin: 0;
                    background-color: #282c34;
                    border-radius: 6px;
                    padding: 0.8rem;
                    color: #f8f9fa;
                  "
                ><code>torch.Size([8, 61]) torch.Size([8, 61])
torch.Size([8, 76]) torch.Size([8, 76])
torch.Size([8, 73]) torch.Size([8, 73])
...</code></pre>
                <p style="margin: 1rem 0 0 0; font-size: 1.1rem">
                  - <strong>8</strong>：表示 batch size<br />
                  - <strong>61 / 76 / 73</strong>：表示這個 batch
                  中，每筆資料經過 padding 後的 token 數量
                </p>
                <p
                  style="
                    margin: 0.5rem 0 0 0;
                    font-size: 1.1rem;
                    font-style: italic;
                  "
                >
                  > 🔁 謝謝我們的 custom collate function，不同 batch
                  可具有不同長度！
                </p>
              </div>
            </div>
          </div>

          <div
            style="
              background-color: #f8f9fa;
              padding: 1.5rem;
              border-radius: 8px;
              border-left: 4px solid #1abc9c;
            "
          >
            <h3
              style="
                color: #1abc9c;
                margin-top: 0;
                display: flex;
                align-items: center;
              "
            >
              <span style="font-size: 1.5rem; margin-right: 0.5rem">🔄</span
              >三階段回顧
            </h3>
            <div
              style="
                display: flex;
                flex-direction: column;
                gap: 1rem;
                margin-top: 1rem;
              "
            >
              <div
                style="
                  background-color: white;
                  padding: 1rem;
                  border-radius: 6px;
                  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                "
              >
                <div style="display: flex; flex-direction: column; gap: 0.8rem">
                  <div style="display: flex; align-items: center; gap: 0.5rem">
                    <span style="font-size: 1.2rem; color: #1abc9c">1️⃣</span>
                    <span style="font-size: 1.1rem"
                      >Dataset formatting
                      <span style="color: #1abc9c">✔️</span></span
                    >
                  </div>
                  <div style="display: flex; align-items: center; gap: 0.5rem">
                    <span style="font-size: 1.2rem; color: #1abc9c">2️⃣</span>
                    <span style="font-size: 1.1rem"
                      >Batching with padding/masking
                      <span style="color: #1abc9c">✔️</span></span
                    >
                  </div>
                  <div style="display: flex; align-items: center; gap: 0.5rem">
                    <span style="font-size: 1.2rem; color: #1abc9c">3️⃣</span>
                    <span style="font-size: 1.1rem"
                      >DataLoader 建立
                      <span style="color: #1abc9c">✔️</span></span
                    >
                  </div>
                </div>
                <p
                  style="
                    margin: 1rem 0 0 0;
                    font-size: 1.1rem;
                    font-style: italic;
                  "
                >
                  > 下一步是載入 LLM 並使用這些 batches 微調模型。
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Slide 20: Model Inference Before Fine-tuning -->
    <div class="slide">
      <div class="slide-content">
        <h2><span class="emoji">🧪</span>模型微調前評估</h2>

        <div
          style="
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            margin-top: 1.5rem;
          "
        >
          <div
            style="
              background-color: #f8f9fa;
              padding: 1.5rem;
              border-radius: 8px;
              border-left: 4px solid #3498db;
            "
          >
            <h3
              style="
                color: #3498db;
                margin-top: 0;
                display: flex;
                align-items: center;
              "
            >
              <span style="font-size: 1.5rem; margin-right: 0.5rem">📝</span
              >評估目的
            </h3>
            <p style="font-size: 1.1rem; line-height: 1.5">
              在進行指令微調前，先評估預訓練模型的原始表現，以便與微調後的結果進行比較，了解微調的效果。
            </p>
          </div>

          <div
            style="
              background-color: #f8f9fa;
              padding: 1.5rem;
              border-radius: 8px;
              border-left: 4px solid #2ecc71;
            "
          >
            <h3
              style="
                color: #2ecc71;
                margin-top: 0;
                display: flex;
                align-items: center;
              "
            >
              <span style="font-size: 1.5rem; margin-right: 0.5rem">💻</span
              >輸入測試資料
            </h3>
            <div
              style="
                background-color: white;
                padding: 1rem;
                border-radius: 6px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                margin-top: 1rem;
              "
            >
              <div style="display: flex; align-items: flex-start; gap: 0.5rem">
                <span style="font-size: 1.2rem; color: #2ecc71">📌</span>
                <pre
                  style="
                    margin: 0;
                    background-color: #282c34;
                    border-radius: 6px;
                    padding: 0.8rem;
                  "
                ><code class="language-python">torch.manual_seed(123)
input_text = format_input(val_data[0])
print(input_text)</code></pre>
              </div>
            </div>
          </div>

          <div
            style="
              background-color: #f8f9fa;
              padding: 1.5rem;
              border-radius: 8px;
              border-left: 4px solid #e74c3c;
            "
          >
            <h3
              style="
                color: #e74c3c;
                margin-top: 0;
                display: flex;
                align-items: center;
              "
            >
              <span style="font-size: 1.5rem; margin-right: 0.5rem">📥</span
              >測試內容
            </h3>
            <div
              style="
                background-color: white;
                padding: 1rem;
                border-radius: 6px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                margin-top: 1rem;
              "
            >
              <div style="display: flex; align-items: flex-start; gap: 0.5rem">
                <span style="font-size: 1.2rem; color: #e74c3c">📌</span>
                <pre
                  style="
                    margin: 0;
                    background-color: #282c34;
                    border-radius: 6px;
                    padding: 0.8rem;
                  "
                ><code class="language-text">Convert the active sentence to passive: 'The chef cooks the meal every day.'</code></pre>
              </div>
            </div>
          </div>

          <div
            style="
              background-color: #f8f9fa;
              padding: 1.5rem;
              border-radius: 8px;
              border-left: 4px solid #9b59b6;
            "
          >
            <h3
              style="
                color: #9b59b6;
                margin-top: 0;
                display: flex;
                align-items: center;
              "
            >
              <span style="font-size: 1.5rem; margin-right: 0.5rem">🔍</span
              >預期結果
            </h3>
            <div
              style="
                display: flex;
                flex-direction: column;
                gap: 1rem;
                margin-top: 1rem;
              "
            >
              <div
                style="
                  background-color: white;
                  padding: 1rem;
                  border-radius: 6px;
                  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                "
              >
                <h4
                  style="
                    color: #9b59b6;
                    margin: 0 0 0.5rem 0;
                    display: flex;
                    align-items: center;
                  "
                >
                  <span style="font-size: 1.2rem; margin-right: 0.5rem">✅</span
                  >正確答案
                </h4>
                <p style="margin: 0; font-size: 1.1rem">
                  The meal is cooked by the chef every day.
                </p>
              </div>

              <div
                style="
                  background-color: white;
                  padding: 1rem;
                  border-radius: 6px;
                  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                "
              >
                <h4
                  style="
                    color: #9b59b6;
                    margin: 0 0 0.5rem 0;
                    display: flex;
                    align-items: center;
                  "
                >
                  <span style="font-size: 1.2rem; margin-right: 0.5rem">❓</span
                  >預訓練模型可能的回應
                </h4>
                <p style="margin: 0; font-size: 1.1rem">
                  預訓練模型可能無法正確理解指令，或生成與指令無關的內容，這正是我們需要進行指令微調的原因。
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Slide 21: Generating Response and Results Observation -->
    <div class="slide">
      <div class="slide-content">
        <h2><span class="emoji">🚀</span>模型回應生成與結果觀察</h2>

        <div
          style="
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            margin-top: 1.5rem;
          "
        >
          <div
            style="
              background-color: #f8f9fa;
              padding: 1.5rem;
              border-radius: 8px;
              border-left: 4px solid #3498db;
            "
          >
            <h3
              style="
                color: #3498db;
                margin-top: 0;
                display: flex;
                align-items: center;
              "
            >
              <span style="font-size: 1.5rem; margin-right: 0.5rem">💻</span
              >生成回應代碼
            </h3>
            <div
              style="
                background-color: white;
                padding: 1rem;
                border-radius: 6px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                margin-top: 1rem;
              "
            >
              <div style="display: flex; align-items: flex-start; gap: 0.5rem">
                <span style="font-size: 1.2rem; color: #3498db">📌</span>
                <pre
                  style="
                    margin: 0;
                    background-color: #282c34;
                    border-radius: 6px;
                    padding: 0.8rem;
                  "
                ><code class="language-python">from chapter05 import generate, text_to_token_ids, token_ids_to_text

token_ids = generate(
    model=model,
    idx=text_to_token_ids(input_text, tokenizer),
    max_new_tokens=35,
    context_size=BASE_CONFIG["context_length"],
    eos_id=50256,
)

generated_text = token_ids_to_text(token_ids, tokenizer)

# 去除開頭的 input prompt，保留 response 部分
response_text = generated_text[len(input_text):].strip()
print(response_text)</code></pre>
              </div>
            </div>
          </div>

          <div
            style="
              background-color: #f8f9fa;
              padding: 1.5rem;
              border-radius: 8px;
              border-left: 4px solid #2ecc71;
            "
          >
            <h3
              style="
                color: #2ecc71;
                margin-top: 0;
                display: flex;
                align-items: center;
              "
            >
              <span style="font-size: 1.5rem; margin-right: 0.5rem">📊</span
              >結果觀察
            </h3>
            <div
              style="
                display: flex;
                flex-direction: column;
                gap: 1rem;
                margin-top: 1rem;
              "
            >
              <div
                style="
                  background-color: white;
                  padding: 1rem;
                  border-radius: 6px;
                  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                "
              >
                <h4
                  style="
                    color: #2ecc71;
                    margin: 0 0 0.5rem 0;
                    display: flex;
                    align-items: center;
                  "
                >
                  <span style="font-size: 1.2rem; margin-right: 0.5rem">🔍</span
                  >預訓練模型回應
                </h4>
                <div
                  style="
                    background-color: #f1f1f1;
                    padding: 0.8rem;
                    border-radius: 4px;
                    font-family: monospace;
                    font-size: 1rem;
                  "
                >
                  "The chef cooks the meal every day. The chef is cooking the
                  meal. The chef has cooked the meal. The chef will cook the
                  meal. The chef is going to cook the meal."
                </div>
              </div>

              <div
                style="
                  background-color: white;
                  padding: 1rem;
                  border-radius: 6px;
                  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                "
              >
                <h4
                  style="
                    color: #2ecc71;
                    margin: 0 0 0.5rem 0;
                    display: flex;
                    align-items: center;
                  "
                >
                  <span style="font-size: 1.2rem; margin-right: 0.5rem">✅</span
                  >正確答案
                </h4>
                <div
                  style="
                    background-color: #f1f1f1;
                    padding: 0.8rem;
                    border-radius: 4px;
                    font-family: monospace;
                    font-size: 1rem;
                  "
                >
                  "The meal is cooked by the chef every day."
                </div>
              </div>

              <div
                style="
                  background-color: white;
                  padding: 1rem;
                  border-radius: 6px;
                  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                "
              >
                <h4
                  style="
                    color: #2ecc71;
                    margin: 0 0 0.5rem 0;
                    display: flex;
                    align-items: center;
                  "
                >
                  <span style="font-size: 1.2rem; margin-right: 0.5rem">❌</span
                  >分析
                </h4>
                <p style="margin: 0; font-size: 1.1rem">
                  預訓練模型無法理解「Convert the active sentence to
                  passive」的指令，只是重複了輸入的句子，並生成了一些相關但不符合指令的句子。這表明模型需要進行指令微調，以學習如何遵循特定指令。
                </p>
              </div>
            </div>
          </div>

          <div
            style="
              background-color: #f8f9fa;
              padding: 1.5rem;
              border-radius: 8px;
              border-left: 4px solid #e74c3c;
            "
          >
            <h3
              style="
                color: #e74c3c;
                margin-top: 0;
                display: flex;
                align-items: center;
              "
            >
              <span style="font-size: 1.5rem; margin-right: 0.5rem">🔮</span
              >微調後預期結果
            </h3>
            <div
              style="
                display: flex;
                flex-direction: column;
                gap: 1rem;
                margin-top: 1rem;
              "
            >
              <div
                style="
                  background-color: white;
                  padding: 1rem;
                  border-radius: 6px;
                  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                "
              >
                <h4
                  style="
                    color: #e74c3c;
                    margin: 0 0 0.5rem 0;
                    display: flex;
                    align-items: center;
                  "
                >
                  <span style="font-size: 1.2rem; margin-right: 0.5rem">✨</span
                  >預期回應
                </h4>
                <div
                  style="
                    background-color: #f1f1f1;
                    padding: 0.8rem;
                    border-radius: 4px;
                    font-family: monospace;
                    font-size: 1rem;
                  "
                >
                  "The meal is cooked by the chef every day."
                </div>
              </div>

              <div
                style="
                  background-color: white;
                  padding: 1rem;
                  border-radius: 6px;
                  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                "
              >
                <h4
                  style="
                    color: #e74c3c;
                    margin: 0 0 0.5rem 0;
                    display: flex;
                    align-items: center;
                  "
                >
                  <span style="font-size: 1.2rem; margin-right: 0.5rem">📈</span
                  >微調效果
                </h4>
                <p style="margin: 0; font-size: 1.1rem">
                  通過指令微調，模型將學會理解並執行「Convert the active
                  sentence to
                  passive」等指令，能夠正確地將主動語態轉換為被動語態，而不是簡單地重複輸入或生成無關內容。
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Slide 22: Fine-tuning the LLM on Instruction Data -->
    <div class="slide">
      <div class="slide-content">
        <h2>
          <span class="emoji">📘</span>7.6 重點整理：對 LLM 進行指令資料微調
        </h2>

        <div
          style="
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            margin-top: 1.5rem;
          "
        >
          <div
            style="
              background-color: #f8f9fa;
              padding: 1.5rem;
              border-radius: 8px;
              border-left: 4px solid #3498db;
            "
          >
            <h3
              style="
                color: #3498db;
                margin-top: 0;
                display: flex;
                align-items: center;
              "
            >
              <span style="font-size: 1.5rem; margin-right: 0.5rem">🎯</span
              >微調流程目標
            </h3>
            <p style="font-size: 1.1rem; line-height: 1.5">
              這一步驟正式進入微調階段，使用前面準備好的：
            </p>
            <ul style="font-size: 1.1rem; line-height: 1.5">
              <li>Instruction dataset（訓練資料）</li>
              <li>Customized DataLoader</li>
              <li>預訓練模型（GPT-2 Medium）</li>
            </ul>
          </div>

          <div
            style="
              background-color: #f8f9fa;
              padding: 1.5rem;
              border-radius: 8px;
              border-left: 4px solid #2ecc71;
            "
          >
            <h3
              style="
                color: #2ecc71;
                margin-top: 0;
                display: flex;
                align-items: center;
              "
            >
              <span style="font-size: 1.5rem; margin-right: 0.5rem">📋</span
              >微調流程步驟
            </h3>
            <div
              style="
                display: flex;
                flex-direction: column;
                gap: 1rem;
                margin-top: 1rem;
              "
            >
              <div
                style="
                  background-color: white;
                  padding: 1rem;
                  border-radius: 6px;
                  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                "
              >
                <div style="display: flex; align-items: center; gap: 0.5rem">
                  <span style="font-size: 1.2rem; color: #2ecc71">1️⃣</span>
                  <span style="font-size: 1.1rem">計算初始訓練 / 驗證損失</span>
                </div>
              </div>

              <div
                style="
                  background-color: white;
                  padding: 1rem;
                  border-radius: 6px;
                  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                "
              >
                <div style="display: flex; align-items: center; gap: 0.5rem">
                  <span style="font-size: 1.2rem; color: #2ecc71">2️⃣</span>
                  <span style="font-size: 1.1rem">設定優化器與學習率</span>
                </div>
              </div>

              <div
                style="
                  background-color: white;
                  padding: 1rem;
                  border-radius: 6px;
                  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                "
              >
                <div style="display: flex; align-items: center; gap: 0.5rem">
                  <span style="font-size: 1.2rem; color: #2ecc71">3️⃣</span>
                  <span style="font-size: 1.1rem">執行訓練循環</span>
                </div>
              </div>

              <div
                style="
                  background-color: white;
                  padding: 1rem;
                  border-radius: 6px;
                  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                "
              >
                <div style="display: flex; align-items: center; gap: 0.5rem">
                  <span style="font-size: 1.2rem; color: #2ecc71">4️⃣</span>
                  <span style="font-size: 1.1rem">定期評估模型性能</span>
                </div>
              </div>

              <div
                style="
                  background-color: white;
                  padding: 1rem;
                  border-radius: 6px;
                  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                "
              >
                <div style="display: flex; align-items: center; gap: 0.5rem">
                  <span style="font-size: 1.2rem; color: #2ecc71">5️⃣</span>
                  <span style="font-size: 1.1rem">保存最佳模型</span>
                </div>
              </div>
            </div>
          </div>

          <div
            style="
              background-color: #f8f9fa;
              padding: 1.5rem;
              border-radius: 8px;
              border-left: 4px solid #e74c3c;
            "
          >
            <h3
              style="
                color: #e74c3c;
                margin-top: 0;
                display: flex;
                align-items: center;
              "
            >
              <span style="font-size: 1.5rem; margin-right: 0.5rem">📊</span
              >微調效果評估
            </h3>
            <div
              style="
                display: flex;
                flex-direction: column;
                gap: 1rem;
                margin-top: 1rem;
              "
            >
              <div
                style="
                  background-color: white;
                  padding: 1rem;
                  border-radius: 6px;
                  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                "
              >
                <h4
                  style="
                    color: #e74c3c;
                    margin: 0 0 0.5rem 0;
                    display: flex;
                    align-items: center;
                  "
                >
                  <span style="font-size: 1.2rem; margin-right: 0.5rem">📈</span
                  >損失函數變化
                </h4>
                <p style="margin: 0; font-size: 1.1rem">
                  觀察訓練和驗證損失的變化趨勢，確保模型正在學習而不是過擬合。
                </p>
              </div>

              <div
                style="
                  background-color: white;
                  padding: 1rem;
                  border-radius: 6px;
                  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                "
              >
                <h4
                  style="
                    color: #e74c3c;
                    margin: 0 0 0.5rem 0;
                    display: flex;
                    align-items: center;
                  "
                >
                  <span style="font-size: 1.2rem; margin-right: 0.5rem">🎯</span
                  >指令遵循能力
                </h4>
                <p style="margin: 0; font-size: 1.1rem">
                  通過指令微調，模型將學會理解並執行「Convert the active
                  sentence to
                  passive」等指令，能夠正確地將主動語態轉換為被動語態，而不是簡單地重複輸入或生成無關內容。
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Slide 23: Hardware Recommendations -->
    <div class="slide">
      <div class="slide-content">
        <h2><span class="emoji">🧠</span>補充：硬體建議</h2>

        <div
          style="
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            margin-top: 1.5rem;
          "
        >
          <div
            style="
              background-color: #f8f9fa;
              padding: 1.5rem;
              border-radius: 8px;
              border-left: 4px solid #3498db;
            "
          >
            <h3
              style="
                color: #3498db;
                margin-top: 0;
                display: flex;
                align-items: center;
              "
            >
              <span style="font-size: 1.5rem; margin-right: 0.5rem">💻</span
              >硬體效能比較
            </h3>
            <div style="margin-top: 1rem; text-align: center">
              <img
                src="images/fig7_16.PNG"
                alt="hardware recommendation"
                style="
                  max-width: 100%;
                  border-radius: 8px;
                  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                "
              />
            </div>
          </div>

          <div
            style="
              background-color: #f8f9fa;
              padding: 1.5rem;
              border-radius: 8px;
              border-left: 4px solid #2ecc71;
            "
          >
            <h3
              style="
                color: #2ecc71;
                margin-top: 0;
                display: flex;
                align-items: center;
              "
            >
              <span style="font-size: 1.5rem; margin-right: 0.5rem">🔧</span
              >資源有限時的優化方案
            </h3>
            <div
              style="
                display: flex;
                flex-direction: column;
                gap: 1rem;
                margin-top: 1rem;
              "
            >
              <div
                style="
                  background-color: white;
                  padding: 1rem;
                  border-radius: 6px;
                  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                "
              >
                <div style="display: flex; align-items: center; gap: 0.5rem">
                  <span style="font-size: 1.2rem; color: #2ecc71">1️⃣</span>
                  <span style="font-size: 1.1rem"
                    >使用 <code>gpt2-small</code> 模型</span
                  >
                </div>
                <p style="margin: 0.5rem 0 0 0; font-size: 1rem; color: #666">
                  模型參數量從 355M 降至 124M，大幅減少記憶體需求
                </p>
              </div>

              <div
                style="
                  background-color: white;
                  padding: 1rem;
                  border-radius: 6px;
                  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                "
              >
                <div style="display: flex; align-items: center; gap: 0.5rem">
                  <span style="font-size: 1.2rem; color: #2ecc71">2️⃣</span>
                  <span style="font-size: 1.1rem"
                    >調整批次大小 <code>batch_size</code></span
                  >
                </div>
                <p style="margin: 0.5rem 0 0 0; font-size: 1rem; color: #666">
                  減少每批次處理的樣本數量，降低 GPU 記憶體使用
                </p>
              </div>

              <div
                style="
                  background-color: white;
                  padding: 1rem;
                  border-radius: 6px;
                  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                "
              >
                <div style="display: flex; align-items: center; gap: 0.5rem">
                  <span style="font-size: 1.2rem; color: #2ecc71">3️⃣</span>
                  <span style="font-size: 1.1rem"
                    >限制序列長度 <code>allowed_max_length</code></span
                  >
                </div>
                <p style="margin: 0.5rem 0 0 0; font-size: 1rem; color: #666">
                  縮短輸入序列的最大長度，進一步減少計算資源需求
                </p>
              </div>
            </div>
          </div>

          <div
            style="
              background-color: #f8f9fa;
              padding: 1.5rem;
              border-radius: 8px;
              border-left: 4px solid #e74c3c;
            "
          >
            <h3
              style="
                color: #e74c3c;
                margin-top: 0;
                display: flex;
                align-items: center;
              "
            >
              <span style="font-size: 1.5rem; margin-right: 0.5rem">⚡</span
              >效能提升效果
            </h3>
            <div
              style="
                display: flex;
                flex-direction: column;
                gap: 1rem;
                margin-top: 1rem;
              "
            >
              <div
                style="
                  background-color: white;
                  padding: 1rem;
                  border-radius: 6px;
                  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                "
              >
                <h4
                  style="
                    color: #e74c3c;
                    margin: 0 0 0.5rem 0;
                    display: flex;
                    align-items: center;
                  "
                >
                  <span style="font-size: 1.2rem; margin-right: 0.5rem">🚀</span
                  >GPU 加速
                </h4>
                <p style="margin: 0; font-size: 1.1rem">
                  使用 NVIDIA A100 GPU 可將訓練時間從 15.78 分鐘縮短至 1.83
                  分鐘，提升約 8.6 倍效能
                </p>
              </div>

              <div
                style="
                  background-color: white;
                  padding: 1rem;
                  border-radius: 6px;
                  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                "
              >
                <h4
                  style="
                    color: #e74c3c;
                    margin: 0 0 0.5rem 0;
                    display: flex;
                    align-items: center;
                  "
                >
                  <span style="font-size: 1.2rem; margin-right: 0.5rem">📉</span
                  >模型縮小
                </h4>
                <p style="margin: 0; font-size: 1.1rem">
                  使用 gpt2-small 模型在 A100 GPU 上僅需 0.39 分鐘，比
                  gpt2-medium 快約 4.7 倍
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Slide 24: Initial Loss Calculation -->
    <div class="slide">
      <div class="slide-content">
        <h2><span class="emoji">✅</span>初始損失計算</h2>
        <p>使用第 5 章的工具函數：</p>
        <pre><code class="language-python">from chapter05 import calc_loss_loader, train_model_simple

model.to(device)
torch.manual_seed(123)

with torch.no_grad():
    train_loss = calc_loss_loader(train_loader, model, device, num_batches=5)
    val_loss = calc_loss_loader(val_loader, model, device, num_batches=5)

print("Training loss:", train_loss)
print("Validation loss:", val_loss)</code></pre>

        <h3>📥 範例輸出：</h3>
        <pre><code class="language-text">Training loss: 3.825...
Validation loss: 3.761...</code></pre>
      </div>
    </div>

    <!-- Slide 25: Fine-tuning Training -->
    <div class="slide">
      <div class="slide-content">
        <h2><span class="emoji">✅</span>執行微調訓練</h2>
        <pre><code class="language-python">import time

start_time = time.time()
torch.manual_seed(123)

optimizer = torch.optim.AdamW(
    model.parameters(), lr=0.00005, weight_decay=0.1
)

num_epochs = 2

train_losses, val_losses, token_seen = train_model_simple(
    model, train_loader, val_loader, optimizer, device,
    num_epochs=num_epochs, eval_freq=5, eval_iters=5,
    start_context=format_input(val_data[0]),
    tokenizer=tokenizer
)

end_time = time.time()
print(f"Training completed in {(end_time - start_time) / 60:.2f} minutes.")</code></pre>
      </div>
    </div>

    <!-- Slide 26: Training Output Observation and Loss Curves -->
    <div class="slide">
      <div class="slide-content">
        <h2><span class="emoji">📊</span>訓練輸出觀察與損失曲線分析</h2>

        <div
          style="
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            margin-top: 1.5rem;
          "
        >
          <div
            style="
              background-color: #f8f9fa;
              padding: 1.5rem;
              border-radius: 8px;
              border-left: 4px solid #3498db;
            "
          >
            <h3
              style="
                color: #3498db;
                margin-top: 0;
                display: flex;
                align-items: center;
              "
            >
              <span style="font-size: 1.5rem; margin-right: 0.5rem">📈</span
              >訓練過程輸出
            </h3>
            <pre><code class="language-text">Ep 1 (Step 000015): Train loss 2.637, Val loss 2.626
Ep 1 (Step 000050): Train loss 1.174, Val loss 1.104
...
Ep 2 (Step 000150): Train loss 0.300, Val loss 0.657</code></pre>
          </div>

          <div
            style="
              background-color: #f8f9fa;
              padding: 1.5rem;
              border-radius: 8px;
              border-left: 4px solid #2ecc71;
            "
          >
            <h3
              style="
                color: #2ecc71;
                margin-top: 0;
                display: flex;
                align-items: center;
              "
            >
              <span style="font-size: 1.5rem; margin-right: 0.5rem">✅</span
              >模型產生的回答
            </h3>
            <pre><code class="language-markdown">### Instruction:
Convert the active sentence to passive:
'The chef cooks the meal every day.'

### Response:
The meal is cooked every day by the chef.</code></pre>
            <p style="margin-top: 1rem; font-size: 1.1rem; color: #2ecc71">
              ✅ 顯示模型已學會如何處理「主動轉被動」的任務！
            </p>
          </div>

          <div
            style="
              background-color: #f8f9fa;
              padding: 1.5rem;
              border-radius: 8px;
              border-left: 4px solid #e74c3c;
            "
          >
            <h3
              style="
                color: #e74c3c;
                margin-top: 0;
                display: flex;
                align-items: center;
              "
            >
              <span style="font-size: 1.5rem; margin-right: 0.5rem">📉</span
              >損失曲線分析
            </h3>
            <pre><code class="language-python">from chapter05 import plot_losses

epochs_tensor = torch.linspace(0, num_epochs, len(train_losses))
plot_losses(epochs_tensor, token_seen, train_losses, val_losses)</code></pre>

            <div style="margin-top: 1rem; text-align: center">
              <img
                src="images/fig7_17.PNG"
                alt="loss curve"
                style="
                  max-width: 100%;
                  border-radius: 8px;
                  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                "
              />
            </div>

            <h4
              style="
                color: #e74c3c;
                margin: 1rem 0 0.5rem 0;
                display: flex;
                align-items: center;
              "
            >
              <span style="font-size: 1.2rem; margin-right: 0.5rem">📊</span
              >圖解結果分析
            </h4>
            <ul style="font-size: 1.1rem; line-height: 1.5; margin: 0">
              <li>訓練損失（藍線）和驗證損失（紅線）都呈現下降趨勢</li>
              <li>模型在訓練過程中學習效果良好，沒有明顯過擬合現象</li>
              <li>損失值從初始的2.6降至0.3左右，表明模型成功學習了指令任務</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- Slide 27: Extracting and Saving Responses -->
    <div class="slide">
      <div class="slide-content">
        <h2>
          <span class="emoji">🧠</span>7.7
          重點整理：從微調後的模型產出回應，並儲存進行評估
        </h2>

        <div
          style="
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            margin-top: 1.5rem;
          "
        >
          <div
            style="
              background-color: #f8f9fa;
              padding: 1.5rem;
              border-radius: 8px;
              border-left: 4px solid #3498db;
            "
          >
            <h3
              style="
                color: #3498db;
                margin-top: 0;
                display: flex;
                align-items: center;
              "
            >
              <span style="font-size: 1.5rem; margin-right: 0.5rem">📋</span
              >評估階段概述
            </h3>
            <p style="font-size: 1.1rem; line-height: 1.5">
              這一步是
              <strong style="color: #3498db"
                >Stage 3: Evaluating the LLM</strong
              >
              的第一個步驟，核心目標是：
            </p>
            <div
              style="
                display: flex;
                flex-direction: column;
                gap: 0.8rem;
                margin-top: 1rem;
              "
            >
              <div
                style="
                  background-color: white;
                  padding: 1rem;
                  border-radius: 6px;
                  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                "
              >
                <div style="display: flex; align-items: center; gap: 0.5rem">
                  <span style="font-size: 1.2rem; color: #3498db">1️⃣</span>
                  <span style="font-size: 1.1rem"
                    >使用微調後的模型對 test set 每個指令產生回應</span
                  >
                </div>
              </div>

              <div
                style="
                  background-color: white;
                  padding: 1rem;
                  border-radius: 6px;
                  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                "
              >
                <div style="display: flex; align-items: center; gap: 0.5rem">
                  <span style="font-size: 1.2rem; color: #3498db">2️⃣</span>
                  <span style="font-size: 1.1rem"
                    >儲存這些回應至 JSON 以便後續評估（人工或自動）</span
                  >
                </div>
              </div>

              <div
                style="
                  background-color: white;
                  padding: 1rem;
                  border-radius: 6px;
                  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                "
              >
                <div style="display: flex; align-items: center; gap: 0.5rem">
                  <span style="font-size: 1.2rem; color: #3498db">3️⃣</span>
                  <span style="font-size: 1.1rem"
                    >執行 side-by-side 對比觀察模型表現</span
                  >
                </div>
              </div>
            </div>
          </div>

          <div
            style="
              background-color: #f8f9fa;
              padding: 1.5rem;
              border-radius: 8px;
              border-left: 4px solid #2ecc71;
            "
          >
            <h3
              style="
                color: #2ecc71;
                margin-top: 0;
                display: flex;
                align-items: center;
              "
            >
              <span style="font-size: 1.5rem; margin-right: 0.5rem">💾</span
              >回應儲存格式
            </h3>
            <div style="margin-top: 1rem">
              <pre><code class="language-json">{
  "instruction": "Convert the active sentence to passive: 'The chef cooks the meal every day.'",
  "input": "",
  "output": "The meal is cooked every day by the chef.",
  "model_response": "The meal is cooked every day by the chef."
}</code></pre>
              <p style="margin-top: 1rem; font-size: 1.1rem; color: #2ecc71">
                ✅ 標準化格式便於後續分析和比較
              </p>
            </div>
          </div>

          <div
            style="
              background-color: #f8f9fa;
              padding: 1.5rem;
              border-radius: 8px;
              border-left: 4px solid #e74c3c;
            "
          >
            <h3
              style="
                color: #e74c3c;
                margin-top: 0;
                display: flex;
                align-items: center;
              "
            >
              <span style="font-size: 1.5rem; margin-right: 0.5rem">🔍</span
              >評估方法
            </h3>
            <div
              style="
                display: flex;
                flex-direction: column;
                gap: 1rem;
                margin-top: 1rem;
              "
            >
              <div
                style="
                  background-color: white;
                  padding: 1rem;
                  border-radius: 6px;
                  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                "
              >
                <h4
                  style="
                    color: #e74c3c;
                    margin: 0 0 0.5rem 0;
                    display: flex;
                    align-items: center;
                  "
                >
                  <span style="font-size: 1.2rem; margin-right: 0.5rem">👤</span
                  >人工評估
                </h4>
                <p style="margin: 0; font-size: 1.1rem">
                  由人類評審員根據預設標準對模型回應進行評分，評估其正確性、相關性和語言質量
                </p>
              </div>

              <div
                style="
                  background-color: white;
                  padding: 1rem;
                  border-radius: 6px;
                  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                "
              >
                <h4
                  style="
                    color: #e74c3c;
                    margin: 0 0 0.5rem 0;
                    display: flex;
                    align-items: center;
                  "
                >
                  <span style="font-size: 1.2rem; margin-right: 0.5rem">🤖</span
                  >自動評估
                </h4>
                <p style="margin: 0; font-size: 1.1rem">
                  使用預定義的評估指標（如 BLEU、ROUGE、BERTScore
                  等）自動計算模型回應與參考答案的相似度
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Slide 28: Evaluation Process -->
    <div class="slide">
      <div class="slide-content">
        <h2><span class="emoji">✅</span>評估模型回應品質</h2>
        <p>使用 prompt 請 LLaMA 回傳「0–100 分數」：</p>
        <pre><code class="language-python">def generate_model_scores(json_data, json_key="model_response", model="llama3"):
    scores = []
    for entry in tqdm(json_data, desc="Scoring entries"):
        prompt = (
            f"Given the input `{format_input(entry)}` "
            f"and correct output `{entry['output']}`, "
            f"score the model response `{entry[json_key]}` "
            f"on a scale from 0 to 100, where 100 is the best score. "
            f"Respond with the integer number only."
        )
        score = query_model(prompt, model)
        try:
            scores.append(int(score))
        except ValueError:
            print(f"Could not convert score: {score}")
            continue
    return scores</code></pre>
      </div>
    </div>

    <!-- Slide 29: Execute and Calculate Average Score -->
    <div class="slide">
      <div class="slide-content">
        <h2><span class="emoji">🧪</span>實際執行與平均分計算</h2>
        <pre><code class="language-python">scores = generate_model_scores(test_data, "model_response")

print(f"Number of scores: {len(scores)} / {len(test_data)}")
print(f"Average score: {sum(scores)/len(scores):.2f}")</code></pre>

        <h3>📥 範例輸出：</h3>
        <pre><code class="language-text">Number of scores: 110 / 110
Average score: 50.32</code></pre>
      </div>
    </div>

    <!-- Slide 30: Improvement Suggestions -->
    <div class="slide">
      <div class="slide-content">
        <h2><span class="emoji">🔍</span>改進建議</h2>

        <div style="display: flex; gap: 1.5rem; margin-top: 1.5rem">
          <div
            style="
              background-color: #f8f9fa;
              padding: 1.5rem;
              border-radius: 8px;
              border-left: 4px solid #3498db;
            "
          >
            <h3
              style="
                color: #3498db;
                margin-top: 0;
                display: flex;
                align-items: center;
              "
            >
              <span style="font-size: 1.5rem; margin-right: 0.5rem">📈</span
              >模型表現提升方案
            </h3>
            <div
              style="
                display: flex;
                flex-direction: column;
                gap: 0.8rem;
                margin-top: 1rem;
              "
            >
              <div
                style="
                  background-color: white;
                  padding: 1rem;
                  border-radius: 6px;
                  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                "
              >
                <div style="display: flex; align-items: center; gap: 0.5rem">
                  <span style="font-size: 1.2rem; color: #3498db">1️⃣</span>
                  <span style="font-size: 1.1rem">調整訓練參數</span>
                </div>
                <p style="margin: 0.5rem 0 0 0; font-size: 1rem; color: #666">
                  增加 epochs / batch size / learning rate 以優化訓練過程
                </p>
              </div>

              <div
                style="
                  background-color: white;
                  padding: 1rem;
                  border-radius: 6px;
                  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                "
              >
                <div style="display: flex; align-items: center; gap: 0.5rem">
                  <span style="font-size: 1.2rem; color: #3498db">2️⃣</span>
                  <span style="font-size: 1.1rem">擴增訓練資料</span>
                </div>
                <p style="margin: 0.5rem 0 0 0; font-size: 1rem; color: #666">
                  使用更豐富的資料集（如 Alpaca）提升模型學習效果
                </p>
              </div>

              <div
                style="
                  background-color: white;
                  padding: 1rem;
                  border-radius: 6px;
                  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                "
              >
                <div style="display: flex; align-items: center; gap: 0.5rem">
                  <span style="font-size: 1.2rem; color: #3498db">3️⃣</span>
                  <span style="font-size: 1.1rem">使用更大的模型</span>
                </div>
                <p style="margin: 0.5rem 0 0 0; font-size: 1rem; color: #666">
                  嘗試 LLaMA 13B、GPT-4 等更大規模的模型
                </p>
              </div>

              <div
                style="
                  background-color: white;
                  padding: 1rem;
                  border-radius: 6px;
                  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                "
              >
                <div style="display: flex; align-items: center; gap: 0.5rem">
                  <span style="font-size: 1.2rem; color: #3498db">4️⃣</span>
                  <span style="font-size: 1.1rem">優化提示詞設計</span>
                </div>
                <p style="margin: 0.5rem 0 0 0; font-size: 1rem; color: #666">
                  改變 prompt 風格以提升訓練效果和模型回應品質
                </p>
              </div>
            </div>
          </div>

          <div
            style="
              background-color: #f8f9fa;
              padding: 1.5rem;
              border-radius: 8px;
              border-left: 4px solid #e74c3c;
            "
          >
            <h3
              style="
                color: #e74c3c;
                margin-top: 0;
                display: flex;
                align-items: center;
              "
            >
              <span style="font-size: 1.5rem; margin-right: 0.5rem">📊</span
              >模型效能比較
            </h3>
            <div style="margin-top: 1rem; overflow-x: auto">
              <table
                style="
                  width: 100%;
                  border-collapse: collapse;
                  font-size: 1.1rem;
                "
              >
                <thead>
                  <tr style="background-color: #f1f1f1">
                    <th
                      style="
                        padding: 0.75rem;
                        text-align: left;
                        border-bottom: 2px solid #e74c3c;
                      "
                    >
                      模型
                    </th>
                    <th
                      style="
                        padding: 0.75rem;
                        text-align: center;
                        border-bottom: 2px solid #e74c3c;
                      "
                    >
                      分數
                    </th>
                    <th
                      style="
                        padding: 0.75rem;
                        text-align: center;
                        border-bottom: 2px solid #e74c3c;
                      "
                    >
                      狀態
                    </th>
                  </tr>
                </thead>
                <tbody>
                  <tr style="border-bottom: 1px solid #eee">
                    <td style="padding: 0.75rem">我們訓練的 gpt2-medium-sft</td>
                    <td
                      style="
                        padding: 0.75rem;
                        text-align: center;
                        font-weight: bold;
                      "
                    >
                      50.32
                    </td>
                    <td style="padding: 0.75rem; text-align: center">
                      基礎版本
                    </td>
                  </tr>
                  <tr style="border-bottom: 1px solid #eee">
                    <td style="padding: 0.75rem">llama3-8B (無微調)</td>
                    <td
                      style="
                        padding: 0.75rem;
                        text-align: center;
                        font-weight: bold;
                      "
                    >
                      58.51
                    </td>
                    <td style="padding: 0.75rem; text-align: center">
                      預訓練模型
                    </td>
                  </tr>
                  <tr style="border-bottom: 1px solid #eee">
                    <td style="padding: 0.75rem">llama3-8B-sft (有微調)</td>
                    <td
                      style="
                        padding: 0.75rem;
                        text-align: center;
                        font-weight: bold;
                        color: #2ecc71;
                      "
                    >
                      82.6
                    </td>
                    <td
                      style="
                        padding: 0.75rem;
                        text-align: center;
                        color: #2ecc71;
                      "
                    >
                      ✅ 最佳表現
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <p style="margin-top: 1rem; font-size: 1.1rem; color: #e74c3c">
              💡 微調後的 llama3-8B 模型表現最佳，分數提升約 41%
            </p>
          </div>
        </div>
      </div>
    </div>

    <div class="navigation">
      <button class="nav-btn" onclick="prevSlide()">上一頁</button>
      <button class="nav-btn" onclick="nextSlide()">下一頁</button>
    </div>

    <!-- 添加 Prism.js JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/components/prism-json.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/components/prism-bash.min.js"></script>
    <script>
      let currentSlide = 0;
      const slides = document.querySelectorAll(".slide");

      // 从localStorage获取上次查看的幻灯片位置
      function getLastViewedSlide() {
        const lastSlide = localStorage.getItem("lastViewedSlide");
        return lastSlide ? parseInt(lastSlide) : 0;
      }

      // 保存当前幻灯片位置到localStorage
      function saveCurrentSlide() {
        localStorage.setItem("lastViewedSlide", currentSlide);
      }

      function showSlide(n) {
        slides.forEach((slide) => slide.classList.remove("active"));
        currentSlide = (n + slides.length) % slides.length;
        slides[currentSlide].classList.add("active");
        // 保存当前幻灯片位置
        saveCurrentSlide();
        // 重新应用语法高亮
        Prism.highlightAll();
      }

      function nextSlide() {
        showSlide(currentSlide + 1);
      }

      function prevSlide() {
        showSlide(currentSlide - 1);
      }

      // Keyboard navigation
      document.addEventListener("keydown", (e) => {
        if (e.key === "ArrowRight") nextSlide();
        if (e.key === "ArrowLeft") prevSlide();
      });

      // 初始化语法高亮
      document.addEventListener("DOMContentLoaded", (event) => {
        // 从localStorage获取上次查看的幻灯片位置并显示
        const lastSlide = getLastViewedSlide();
        showSlide(lastSlide);
        Prism.highlightAll();
      });
    </script>
  </body>
</html>
